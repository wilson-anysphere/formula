# SAML 2.0 SSO

Formula supports per-organization SAML 2.0 SSO via **SP-initiated** login:

- SP → IdP: HTTP-Redirect (`SAMLRequest`)
- IdP → SP: HTTP-POST callback (`SAMLResponse`)

## Provider configuration (per org)

SAML providers are stored in `org_saml_providers` and managed through org-admin APIs.

### Fields

- `providerId` (path param): A short identifier for the IdP configuration (e.g. `okta`, `azuread`).
- `entryPoint`: IdP SSO URL (must be a valid URL; **HTTPS required in production**).
- `issuer`: Service Provider issuer / Entity ID. This is also used as the SAML **audience** when validating assertions. (Can be a URL or URN; if it’s a URL, HTTPS is required in production.)
- `idpIssuer` (optional): Expected IdP EntityID / Issuer. When set, Formula rejects assertions whose `<saml:Issuer>` does not match. (Can be a URL or URN; if it’s a URL, HTTPS is required in production.)
- `idpCertPem`: IdP signing certificate in PEM format (the public cert used to validate XML signatures).
- `wantAssertionsSigned`: Require `<Assertion>` signatures (default `true`).
- `wantResponseSigned`: Require `<Response>` signatures (default `true`).
- `attributeMapping`: Attribute names used to extract user identity:
  - `email` (required): attribute containing the user email.
  - `name` (required): attribute containing the display name.
  - `groups` (optional): attribute containing groups (currently not persisted).
- `enabled`: Whether this provider can be used for login.

### Certificate format

`idpCertPem` should be a PEM-encoded X.509 certificate, for example:

```
-----BEGIN CERTIFICATE-----
MIIC...
-----END CERTIFICATE-----
```

For convenience, the admin API also accepts a raw base64-encoded certificate string and normalizes it to PEM. Invalid certificates are rejected with `error: "invalid_certificate"`.

### Certificate rollover

To support IdP signing certificate rotation, `idpCertPem` may contain multiple PEM certificates concatenated together. Formula will try each certificate when verifying signatures.

## Admin APIs

All endpoints require an authenticated **org admin**.

- `GET /orgs/:orgId/saml/providers`
- `GET /orgs/:orgId/saml/providers/:providerId`
- `PUT /orgs/:orgId/saml/providers/:providerId`
- `DELETE /orgs/:orgId/saml/providers/:providerId`

Changes emit audit events:

- `admin.integration_added`
- `admin.integration_updated`
- `admin.integration_removed`

with `details: { type: "saml", providerId }`.

## Login flow

### Start login

`GET /auth/saml/:orgId/:provider/start`

Redirects the browser to the IdP `entryPoint` with a `SAMLRequest` query param.

### SP metadata

`GET /auth/saml/:orgId/:provider/metadata`

Returns SP metadata XML (EntityID + ACS URL) for the configured provider.

### Callback (ACS)

`POST /auth/saml/:orgId/:provider/callback`

Accepts `application/x-www-form-urlencoded` POSTs containing:

- `SAMLResponse` (required)
- `RelayState` (required; anti-CSRF token generated by the `/start` endpoint)

On success, Formula:

1. Validates response/assertion signatures, issuer/audience, and time conditions.
    - If the IdP includes `InResponseTo`, Formula validates it against a short-lived request cache and consumes it (replay protection).
    - If the assertion includes a `SubjectConfirmationData Recipient`, Formula requires it to match the ACS URL.
    - If the response includes a `Destination` attribute, Formula requires it to match the ACS URL.
2. Extracts identity via `attributeMapping` and normalizes email.
3. Links the identity in `user_identities` (`provider = providerId`, `subject = NameID`, `org_id = orgId`).
4. Provisions the user + org membership if needed.
5. Issues a session cookie and writes an `auth.login` audit event (`details: { method: "saml", provider }`).

### `allowed_auth_methods`

SAML login is only allowed if the org has `"saml"` present in `org_settings.allowed_auth_methods`.

## Deployment notes

### PUBLIC_BASE_URL (recommended)

Set `PUBLIC_BASE_URL` (example: `https://app.example.com`) in production so the API can build the ACS URL without relying on request headers.

### Rate limiting

The SAML callback endpoint is rate limited per IP to reduce the impact of replay/brute-force attempts.
