# Excel Feature Parity (code-driven)

This document replaces the old hand-maintained “✅/⬜ per function” checklists, which quickly drift
and become misleading.

Instead, parity is reported from authoritative, versioned data sources in the repo and validated by
tests.

## Sources of truth

### Implemented function catalog (authoritative)

The source of truth for “what the engine currently implements” is:

- **[`shared/functionCatalog.json`](../shared/functionCatalog.json)** (and
  [`shared/functionCatalog.mjs`](../shared/functionCatalog.mjs))
  - Kept in sync with the Rust registry by
    **[`crates/formula-engine/tests/function_catalog_sync.rs`](../crates/formula-engine/tests/function_catalog_sync.rs)**.
  - Used by downstream tooling (JS/TS, docs, scripts) without having to compile Rust.
### Excel “function universe” references (informational)

Excel has multiple naming/encoding systems and many “functions” that aren’t worksheet functions
(legacy XLM macro functions, reserved slots, etc). The following sources are useful for context and
coverage tracking:

- **BIFF/XLSB built-in function table (FTAB)**:
  [`crates/formula-biff/src/ftab.rs`](../crates/formula-biff/src/ftab.rs)
  - Lists BIFF `iftab` ids `0..=484` and their canonical names.
  - **Does not** include many modern `_xlfn.` functions (which are commonly encoded as “user-defined”
    calls in BIFF).
- **Excel oracle corpus**:
  [`tests/compatibility/excel-oracle/cases.json`](../tests/compatibility/excel-oracle/cases.json)
  - A curated set of formulas + expected outputs, used to validate behavior against Excel.
  - Good for measuring “real-world” coverage, but not a comprehensive universe of all functions.

## Regenerating / checking

Update the committed function catalog (requires a Rust toolchain):

```bash
pnpm -w run generate:function-catalog
```

Validate that the committed catalog matches the Rust registry:

```bash
cargo test -p formula-engine function_catalog_sync
```

Generate a parity report between `shared/functionCatalog.json` and the BIFF FTAB name table:

```bash
pnpm -w run report:function-parity
```

## Current snapshot (counts only)

Generated by `pnpm -w run report:function-parity`:

```text
Function parity report (catalog ↔ BIFF FTAB)

Catalog functions (shared/functionCatalog.json): 329
FTAB functions (crates/formula-biff/src/ftab.rs): 478
Catalog ∩ FTAB (case-insensitive name match): 244
FTAB \ Catalog (missing from catalog): 234
Catalog \ FTAB (not present in FTAB): 85
```

Run the script locally for the full, sorted “top N” lists.

## Notes on tricky function families

Some function families have especially subtle Excel behavior and deserve dedicated documentation.
For example, odd-coupon bond functions (ODDF\*/ODDL\*) involve Excel-specific conventions around
day-count bases, coupon schedules, accrued interest, and yield solver behavior. See:
[`docs/financial-odd-coupon-bonds.md`](financial-odd-coupon-bonds.md).

## Dependency threshold: 65,536 → “full recalc mode”

Excel has a behavior/implementation detail where, beyond a **65,536 dependency threshold**, it may
switch away from incremental dependency-driven recalculation into a “full recalc” strategy.

In this repo the requirement is tracked here:

- [`instructions/core-engine.md`](../instructions/core-engine.md) (see “Dependency threshold: 65,536
  before full recalc mode”)

Relevant implementation areas (where this is/will be enforced):

- Dependency graph enforcement (limit + fallback):
  [`crates/formula-engine/src/graph/dependency_graph.rs`](../crates/formula-engine/src/graph/dependency_graph.rs)
  - `DependencyGraph::DEFAULT_DIRTY_MARK_LIMIT` (65,536)
  - `DependencyGraph::mark_dirty` falls back to “full recalc” by marking all formula cells dirty when
    propagation exceeds the limit
- Regression tests:
  [`crates/formula-engine/tests/graph_dirty_mark_limit.rs`](../crates/formula-engine/tests/graph_dirty_mark_limit.rs)
  (plus general scaling tests like
  [`crates/formula-engine/tests/graph_stress.rs`](../crates/formula-engine/tests/graph_stress.rs))

Note: The parity report above focuses on **function coverage**. The dependency threshold is a
separate (performance/behavior) parity requirement.
