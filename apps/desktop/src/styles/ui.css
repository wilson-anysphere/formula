/*
  Core UI styles wired entirely through CSS variables defined in tokens.css.
  No hardcoded colors should appear in this file.
*/

.formula-app {
  background: var(--bg-primary);
  color: var(--text-primary);
  font-family: var(--font-sans);
}

a,
a:visited {
  color: var(--link);
}

.formula-app * {
  box-sizing: border-box;
}

.formula-bar {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  gap: var(--space-1);
  padding: var(--space-2) calc(var(--space-4) + var(--space-1));
  background: var(--formula-bar-bg);
  border-bottom: 1px solid var(--formula-bar-border);
  transition:
    background-color var(--motion-duration) var(--motion-ease),
    border-color var(--motion-duration) var(--motion-ease),
    color var(--motion-duration) var(--motion-ease);
}

.formula-bar:focus-within {
  outline: var(--space-1) solid var(--selection-border);
  outline-offset: calc(var(--space-1) * -1);
}

.formula-bar__label {
  color: var(--text-secondary);
  font-weight: 600;
  user-select: none;
}

.formula-bar__input {
  flex: 1;
  padding: var(--space-2) var(--space-4);
  background: var(--bg-primary);
  color: var(--text-primary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  outline: none;
  transition:
    background-color var(--motion-duration) var(--motion-ease),
    border-color var(--motion-duration) var(--motion-ease),
    color var(--motion-duration) var(--motion-ease);
}

.formula-bar__input:focus {
  border-color: var(--selection-border);
  box-shadow: 0 0 0 var(--space-1) var(--selection-bg);
}

/*
  Spreadsheet formula bar (FormulaBarView.ts)
*/

.formula-bar-row {
  display: grid;
  grid-template-columns: 110px auto 1fr auto auto;
  align-items: start;
  gap: var(--space-4);
  min-width: 0;
}

.formula-function-picker {
  position: absolute;
  z-index: 200;
  /* JS computes top/left based on the fx button. Provide a stable fallback. */
  top: calc((var(--space-6) * 2) + var(--space-2));
  left: 0;
}

.formula-function-picker .command-palette {
  width: 420px;
  max-width: calc(100vw - (var(--space-6) + var(--space-4)));
}

.formula-bar-name-box {
  display: flex;
  align-items: stretch;
  min-width: 0;
  background: var(--bg-primary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  transition:
    background-color var(--motion-duration) var(--motion-ease),
    border-color var(--motion-duration) var(--motion-ease);
}

.formula-bar-name-box-wrapper {
  position: relative;
  min-width: 0;
}

.formula-bar-name-box.formula-bar-name-box--invalid {
  border-color: var(--error);
  box-shadow: 0 0 0 var(--space-1) var(--error-bg);
}

.formula-bar-name-box.formula-bar-name-box--invalid:focus-within {
  border-color: var(--error);
  box-shadow: 0 0 0 var(--space-1) var(--error-bg);
}

.formula-bar-name-box-error {
  position: absolute;
  top: calc(100% + var(--space-2));
  left: 0;
  z-index: 10;
  padding: var(--space-2) var(--space-3);
  max-width: 220px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--error);
  background: var(--bg-primary);
  color: var(--error);
  font-size: 11px;
  line-height: 14px;
  pointer-events: none;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  box-shadow: var(--shadow-surface);
}

.formula-bar-name-box-error[hidden] {
  display: none;
}

.formula-bar-address {
  flex: 1;
  min-width: 0;
  border: none;
  outline: none;
  padding: calc(var(--space-3) / 2) var(--space-3);
  background: transparent;
  color: var(--text-primary);
  font-size: 12px;
  line-height: 16px;
  font-family: var(--font-mono);
}

.formula-bar-address:focus {
  background: var(--bg-primary);
}

.formula-bar-name-box:focus-within {
  border-color: var(--selection-border);
  box-shadow: 0 0 0 var(--space-1) var(--selection-bg);
}

.formula-bar-name-box-dropdown {
  width: 20px;
  border: none;
  border-inline-start: 1px solid var(--border);
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 10px;
  padding: 0;
  transition:
    background-color var(--motion-duration) var(--motion-ease),
    color var(--motion-duration) var(--motion-ease);
}

.formula-bar-name-box-dropdown:hover {
  background: var(--bg-tertiary);
  color: var(--text-primary);
}

.formula-bar-name-box-popup {
  position: fixed;
  z-index: 50;
  background: var(--bg-primary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: var(--space-3);
  box-shadow: var(--shadow-surface);
  max-height: 320px;
  overflow: auto;
}

.formula-bar-name-box-popup[hidden] {
  display: none;
}

.formula-bar-name-box-popup-list {
  display: flex;
  flex-direction: column;
  gap: var(--space-2);
  min-width: 0;
}

.formula-bar-name-box-group-label {
  padding: var(--space-1) var(--space-3);
  font-size: 11px;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  color: var(--text-secondary);
  user-select: none;
}

.formula-bar-name-box-option {
  display: flex;
  align-items: center;
  min-width: 0;
  padding: var(--space-3) var(--space-4);
  border-radius: var(--radius-sm);
  cursor: default;
  color: var(--text-primary);
}

.formula-bar-name-box-option:hover {
  background: var(--bg-tertiary);
}

.formula-bar-name-box-option[aria-selected="true"] {
  background: var(--selection-bg);
  color: var(--selection-text);
}

.formula-bar-name-box-option-main {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: var(--space-1);
}

.formula-bar-name-box-option-label {
  font-size: 12px;
  font-weight: 600;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.formula-bar-name-box-option-description {
  font-size: 11px;
  color: var(--text-secondary);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  font-family: var(--font-mono);
}

.formula-bar-name-box-option[aria-selected="true"] .formula-bar-name-box-option-description {
  color: var(--selection-text);
  opacity: 0.85;
}

.formula-bar-name-box-empty {
  padding: var(--space-3) calc(var(--space-4) + var(--space-1));
  font-size: 12px;
  color: var(--text-secondary);
}

.formula-bar-actions {
  display: flex;
  align-items: stretch;
  gap: var(--space-1);
}

.formula-bar-action-button {
  width: 24px;
  height: 24px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border: 1px solid transparent;
  border-radius: var(--radius-sm);
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  user-select: none;
  transition:
    background-color var(--motion-duration) var(--motion-ease),
    border-color var(--motion-duration) var(--motion-ease),
    color var(--motion-duration) var(--motion-ease);
}

.formula-bar-action-button:hover {
  background: var(--bg-tertiary);
  border-color: var(--border);
  color: var(--text-primary);
}

.formula-bar-action-button:focus-visible {
  outline: none;
  border-color: var(--selection-border);
  box-shadow: 0 0 0 var(--space-1) var(--selection-bg);
}

.formula-bar-action-button:disabled {
  opacity: 0.5;
  cursor: default;
}

.formula-bar-action-button--cancel:hover {
  color: var(--error);
}

.formula-bar-action-button--commit:hover {
  color: var(--success);
}

.formula-bar-action-button--fx {
  font-style: italic;
  font-weight: 600;
  font-size: 12px;
}

.formula-bar-editor {
  position: relative;
  min-width: 0;
}

.formula-bar-highlight {
  margin: 0;
  box-sizing: border-box;
  padding: calc(var(--space-1) / 2) var(--space-3);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg-primary);
  overflow: auto;
  font: 13px/20px var(--font-mono);
  white-space: pre;
  transition:
    background-color var(--motion-duration) var(--motion-ease),
    border-color var(--motion-duration) var(--motion-ease),
    color var(--motion-duration) var(--motion-ease);
}

.formula-bar-input {
  position: absolute;
  inset: 0;
  width: 100%;
  box-sizing: border-box;
  padding: calc(var(--space-1) / 2) var(--space-3);
  border: none;
  outline: none;
  resize: none;
  background: transparent;
  color: transparent;
  caret-color: var(--text-primary);
  font: inherit;
  line-height: 20px;
  overflow: auto;
}

/* The formula input is only interactive in edit mode; in view mode we allow hover
   interactions on the highlighted <pre> underneath. */
.formula-bar:not(.formula-bar--editing) .formula-bar-input {
  display: none;
}

.formula-bar.formula-bar--editing .formula-bar-input {
  display: block;
}

.formula-bar-input::selection {
  background: var(--selection-bg);
}

.formula-bar-highlight .formula-bar-ghost {
  color: var(--text-secondary);
  opacity: 0.6;
}

.formula-bar-highlight span[data-kind="function"] {
  color: var(--formula-fn-color);
  font-weight: 600;
}

.formula-bar-highlight span[data-kind="reference"] {
  color: var(--formula-ref-color);
}

.formula-bar-highlight span.formula-bar-reference--active {
  text-decoration: underline;
  text-decoration-thickness: var(--space-1);
  text-underline-offset: var(--space-1);
  text-decoration-color: currentColor;
}

.formula-bar-highlight span[data-kind="string"] {
  color: var(--formula-string-color);
}

.formula-bar-highlight span[data-kind="number"] {
  color: var(--formula-number-color);
}

.formula-bar-highlight span[data-kind="operator"] {
  color: var(--formula-operator-color);
}

.formula-bar-highlight span[data-kind="punctuation"] {
  color: var(--formula-punctuation-color);
}

.formula-bar-highlight span[data-kind="error"] {
  color: var(--formula-error-color);
  font-weight: 600;
}

.formula-bar-highlight span.formula-bar-token--error {
  background: var(--error-bg);
  text-decoration: underline;
  text-decoration-thickness: var(--space-1);
  text-underline-offset: var(--space-1);
  text-decoration-color: var(--error);
  border-radius: var(--radius-xs);
}

.formula-bar-highlight .formula-bar-preview {
  color: var(--text-secondary);
  opacity: 0.8;
  font-size: 12px;
  margin-left: var(--space-3);
}

.formula-bar--function-autocomplete-open .formula-bar-highlight .formula-bar-ghost,
.formula-bar--function-autocomplete-open .formula-bar-highlight .formula-bar-preview {
  display: none;
}

.formula-bar-expand-button {
  width: 24px;
  height: 24px;
  margin-top: 0;
  padding: 0;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border: 1px solid transparent;
  border-radius: var(--radius-sm);
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  user-select: none;
  line-height: 1;
  font-size: 12px;
  transition:
    background-color var(--motion-duration) var(--motion-ease),
    border-color var(--motion-duration) var(--motion-ease),
    color var(--motion-duration) var(--motion-ease);
}

.formula-bar-expand-button:hover {
  background: var(--bg-tertiary);
  border-color: var(--border);
  color: var(--text-primary);
}

.formula-bar-expand-button:focus-visible {
  outline: none;
  border-color: var(--selection-border);
  box-shadow: 0 0 0 var(--space-1) var(--selection-bg);
}

.formula-bar--expanded .formula-bar-expand-button {
  color: var(--text-primary);
}

.formula-bar-function-autocomplete {
  position: absolute;
  top: calc(100% + var(--space-2));
  left: 0;
  right: 0;
  z-index: 30;
  max-height: 280px;
  overflow: auto;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg-primary);
  box-shadow: var(--shadow-surface);
}

.formula-bar-function-autocomplete[hidden] {
  display: none;
}

.formula-bar-function-autocomplete-item {
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: var(--space-1);
  padding: var(--space-3) calc(var(--space-4) + var(--space-1));
  border: none;
  background: transparent;
  color: var(--text-primary);
  text-align: left;
  cursor: pointer;
}

.formula-bar-function-autocomplete-item[aria-selected="true"],
.formula-bar-function-autocomplete-item:hover {
  background: var(--selection-bg);
  color: var(--selection-text);
}

.formula-bar-function-autocomplete-name {
  font-weight: 600;
  font-family: var(--font-mono);
  font-size: 12px;
}

.formula-bar-function-autocomplete-match {
  font-weight: 800;
}

.formula-bar-function-autocomplete-signature {
  font-size: 11px;
  color: var(--text-secondary);
  opacity: 0.9;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  font-family: var(--font-mono);
}

.formula-bar-function-autocomplete-item[aria-selected="true"] .formula-bar-function-autocomplete-signature,
.formula-bar-function-autocomplete-item:hover .formula-bar-function-autocomplete-signature {
  color: var(--selection-text);
  opacity: 0.85;
}

.formula-bar-hint {
  font-size: 12px;
  color: var(--text-secondary);
  line-height: 16px;
  min-height: 16px;
}

.formula-bar-hint.formula-bar-hint--syntax-error {
  /* Keep normal hint styling; the error message itself is styled separately. */
  color: var(--text-secondary);
}

.formula-bar-hint-error {
  margin-bottom: var(--space-2);
  color: var(--error);
}

.formula-bar-hint-panel {
  display: flex;
  flex-direction: column;
  gap: var(--space-2);
}

.formula-bar-hint-title {
  font-size: 10px;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  font-weight: 600;
  color: var(--text-secondary);
  user-select: none;
}

.formula-bar-hint-body {
  display: flex;
  flex-wrap: wrap;
  align-items: baseline;
  padding: var(--space-2) calc(var(--space-4) + var(--space-1));
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg-primary);
  color: var(--text-secondary);
}

.formula-bar-hint-signature {
  font-family: var(--font-mono);
  font-size: 12px;
}

.formula-bar-hint-token {
  white-space: pre;
}

.formula-bar-hint-token--name {
  color: var(--formula-fn-color);
  font-weight: 600;
}

.formula-bar-hint-token--paramActive {
  color: var(--text-primary);
  font-weight: 700;
  background: var(--accent-bg);
  padding: var(--space-0) var(--space-2);
  border-radius: var(--radius-sm);
  box-shadow: inset 0 calc(var(--space-1) * -1) 0 0 var(--accent);
}

.formula-bar-hint-summary-separator {
  color: var(--text-tertiary);
}

.formula-bar-hint-summary {
  color: var(--text-secondary);
}

.formula-bar-hint-arg-preview {
  /* Force preview onto its own line within the flex-wrapping hint body. */
  flex-basis: 100%;
  margin-top: var(--space-2);
  font-family: var(--font-mono);
  white-space: pre-wrap;
  word-break: break-word;
  color: var(--text-tertiary);
}

.formula-bar-error-button {
  /* Hidden by default; shown when the active cell has an error explanation. */
  display: none;
  width: 24px;
  height: 24px;
  margin-top: 0;
  padding: 0;
  align-items: center;
  justify-content: center;
  border: 1px solid var(--error);
  border-radius: var(--radius-sm);
  background: var(--bg-primary);
  color: var(--error);
  font-weight: 700;
  cursor: pointer;
  transition:
    background-color var(--motion-duration) var(--motion-ease),
    border-color var(--motion-duration) var(--motion-ease),
    color var(--motion-duration) var(--motion-ease),
    box-shadow var(--motion-duration) var(--motion-ease);
}

.formula-bar--has-error .formula-bar-error-button {
  display: inline-flex;
}

.formula-bar-error-button:hover {
  background: var(--bg-tertiary);
}

.formula-bar-error-button:focus-visible {
  outline: none;
  border-color: var(--selection-border);
  box-shadow: 0 0 0 var(--space-1) var(--selection-bg);
}

.formula-bar-error-panel {
  /* Hidden by default; toggled open by the error button. */
  display: none;
  padding: var(--space-3) calc(var(--space-4) + var(--space-1));
  border: 1px solid var(--error);
  border-radius: var(--radius);
  background: var(--bg-primary);
  font-size: 12px;
  color: var(--text-primary);
}

.formula-bar--has-error.formula-bar--error-panel-open .formula-bar-error-panel {
  display: block;
}

.formula-bar-error-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: var(--space-4);
  margin-bottom: var(--space-2);
}

.formula-bar-error-title {
  font-weight: 700;
  margin: 0;
}

.formula-bar-error-close {
  width: 24px;
  height: 24px;
  padding: 0;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border: 1px solid transparent;
  border-radius: var(--radius-sm);
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  flex: 0 0 auto;
  transition:
    background-color var(--motion-duration) var(--motion-ease),
    border-color var(--motion-duration) var(--motion-ease),
    color var(--motion-duration) var(--motion-ease);
}

.formula-bar-error-close:hover {
  background: var(--bg-tertiary);
  border-color: var(--border);
  color: var(--text-primary);
}

.formula-bar-error-close:focus-visible {
  outline: none;
  border-color: var(--selection-border);
  box-shadow: 0 0 0 var(--space-1) var(--selection-bg);
}

.formula-bar-error-desc {
  margin-bottom: var(--space-3);
}

.formula-bar-error-suggestions {
  margin: 0;
  padding-left: calc(var(--space-5) + var(--space-3));
}

.formula-bar-error-actions {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-4);
  margin-top: calc(var(--space-4) + var(--space-1));
}

.formula-bar-error-action {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: var(--space-3) calc(var(--space-4) + var(--space-1));
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: var(--bg-secondary);
  color: var(--text-primary);
  font-size: 12px;
  line-height: 16px;
  cursor: pointer;
  user-select: none;
  transition:
    background-color var(--motion-duration) var(--motion-ease),
    border-color var(--motion-duration) var(--motion-ease),
    color var(--motion-duration) var(--motion-ease);
}

.formula-bar-error-action:hover {
  background: var(--bg-tertiary);
}

.formula-bar-error-action:focus-visible {
  outline: none;
  border-color: var(--selection-border);
  box-shadow: 0 0 0 var(--space-1) var(--selection-bg);
}

.formula-bar-error-action:disabled {
  opacity: 0.6;
  cursor: default;
}

.formula-bar-error-action--primary {
  border-color: var(--accent-border);
  background: var(--accent);
  color: var(--text-on-accent);
}

.formula-bar-error-action--primary:hover:not(:disabled) {
  background: var(--accent-hover);
  border-color: var(--accent-hover);
}

.formula-bar-error-action--primary:active:not(:disabled) {
  background: var(--accent-active);
  border-color: var(--accent-active);
}

/*
  Formula-bar range preview tooltip (SpreadsheetApp + FormulaBarView hover bridge)
*/

.formula-range-preview-tooltip {
  position: absolute;
  top: calc(100% + var(--space-3));
  left: calc(var(--space-4) + var(--space-1));
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
  padding: var(--space-3) calc(var(--space-4) + var(--space-1));
  max-width: min(360px, calc(100% - (var(--space-5) + var(--space-4))));
  background: var(--formula-grid-bg, var(--bg-primary));
  border: 1px solid var(--formula-grid-line, var(--border));
  border-radius: var(--radius);
  box-shadow: var(--shadow-surface);
  font-size: 12px;
  color: var(--formula-grid-cell-text, var(--text-primary));
  pointer-events: none;
  user-select: none;
}

.formula-range-preview-tooltip[hidden] {
  display: none;
}

.formula-range-preview-tooltip__header {
  font-weight: 700;
  font-family: var(--font-mono);
  overflow-wrap: anywhere;
}

.formula-range-preview-tooltip__grid {
  border-collapse: collapse;
  table-layout: fixed;
  width: 100%;
  background: var(--formula-grid-bg, var(--bg-primary));
  color: var(--formula-grid-cell-text, var(--text-primary));
}

.formula-range-preview-tooltip__grid td {
  border: 1px solid var(--formula-grid-line, var(--border));
  padding: var(--space-2) var(--space-3);
  min-width: 0;
  background: var(--formula-grid-bg, var(--bg-primary));
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-family: var(--font-mono);
}

.formula-range-preview-tooltip__summary {
  color: inherit;
  opacity: 0.75;
}

@media (forced-colors: active), (prefers-contrast: more) {
  .formula-range-preview-tooltip__summary {
    opacity: 1;
  }
}

:root[data-theme="high-contrast"] .formula-range-preview-tooltip__summary {
  opacity: 1;
}

.grid {
  display: grid;
  grid-template-columns: auto 1fr;
  border-top: 1px solid var(--formula-grid-line, var(--grid-line));
  color: var(--formula-grid-cell-text, var(--text-primary));
}

.grid__headers {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 80px repeat(6, 1fr);
  background: var(--formula-grid-header-bg, var(--grid-header-bg));
  color: var(--formula-grid-header-text, var(--grid-header-text));
  border-bottom: 1px solid var(--formula-grid-line, var(--grid-line));
}

.grid__header-cell {
  padding: var(--space-4) calc(var(--space-4) + var(--space-1));
  border-right: 1px solid var(--formula-grid-line, var(--grid-line));
  font-weight: 600;
  user-select: none;
}

.grid__body {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 80px repeat(6, 1fr);
  background: var(--formula-grid-bg, var(--bg-primary));
}

.grid__row-header,
.grid__cell {
  padding: var(--space-4) calc(var(--space-4) + var(--space-1));
  border-right: 1px solid var(--formula-grid-line, var(--grid-line));
  border-bottom: 1px solid var(--formula-grid-line, var(--grid-line));
  min-height: 32px;
}

.grid__row-header {
  background: var(--formula-grid-header-bg, var(--grid-header-bg));
  color: var(--formula-grid-header-text, var(--grid-header-text));
  font-weight: 600;
  user-select: none;
}

.grid__cell--selected {
  background: var(--formula-grid-selection-fill, var(--selection-fill, var(--selection-bg)));
  color: var(--formula-grid-cell-text, var(--text-primary));
  outline: var(--space-1) solid var(--formula-grid-selection-border, var(--selection-border));
  outline-offset: calc(var(--space-1) * -1);
}

.formula-table-header-cell {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: var(--space-3);
  padding: var(--space-0) var(--space-3);
  height: 100%;
  font-weight: 600;
  background: transparent;
}

.formula-table-header-cell--styled {
  background: var(--formula-grid-header-bg, var(--grid-header-bg));
  color: var(--formula-grid-header-text, var(--grid-header-text));
}

.formula-table-filter-button {
  width: 18px;
  height: 18px;
  padding: 0;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border: 1px solid transparent;
  border-radius: var(--radius-sm);
  background: transparent;
  color: inherit;
  cursor: pointer;
  flex: 0 0 auto;
  user-select: none;
  line-height: 1;
  font-size: 10px;
  opacity: 0.7;
  transition:
    background-color var(--motion-duration) var(--motion-ease),
    border-color var(--motion-duration) var(--motion-ease),
    color var(--motion-duration) var(--motion-ease);
}

.formula-table-filter-button:hover {
  background: var(--formula-grid-scrollbar-track, var(--bg-hover));
  border-color: var(--formula-grid-line, var(--border));
  opacity: 1;
}

.formula-table-filter-button:active {
  background: var(--formula-grid-scrollbar-track, var(--bg-active));
}

.formula-table-filter-button:focus-visible {
  outline: none;
  border-color: var(--formula-grid-selection-border, var(--selection-border));
  box-shadow: 0 0 0 var(--space-1) var(--formula-grid-selection-fill, var(--selection-fill, var(--selection-bg)));
  opacity: 1;
}

.formula-table-filter-button:disabled {
  opacity: 0.5;
  cursor: default;
}

@media (forced-colors: active), (prefers-contrast: more) {
  .formula-table-filter-button {
    opacity: 1;
  }
}

:root[data-theme="high-contrast"] .formula-table-filter-button {
  opacity: 1;
}

.panel {
  background: var(--panel-bg);
  border: 1px solid var(--panel-border);
  border-radius: var(--radius);
  padding: var(--space-4);
  transition:
    background-color var(--motion-duration) var(--motion-ease),
    border-color var(--motion-duration) var(--motion-ease),
    color var(--motion-duration) var(--motion-ease);
}

.panel__title {
  margin: 0 0 var(--space-4);
  font-size: 12px;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  color: var(--text-secondary);
}

/* --- AI inline edit ------------------------------------------------------- */

.ai-inline-edit-overlay {
  position: absolute;
  z-index: 20;
  top: var(--space-6);
  left: var(--space-6);
  width: min(520px, calc(100% - (var(--space-6) * 2)));
}

.ai-inline-edit-overlay[hidden] {
  display: none;
}

.ai-inline-edit-error[hidden],
.ai-inline-edit-preview[hidden] {
  display: none;
}

.command-palette {
  background: var(--cmdk-bg);
  border: 1px solid var(--cmdk-border);
  border-radius: var(--radius);
  padding: var(--space-4) calc(var(--space-4) + var(--space-1));
  width: 420px;
  transition:
    background-color var(--motion-duration) var(--motion-ease),
    border-color var(--motion-duration) var(--motion-ease),
    color var(--motion-duration) var(--motion-ease);
}

.command-palette__input {
  width: 100%;
  padding: var(--space-2) calc(var(--space-4) + var(--space-1));
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: var(--cmdk-input-bg);
  color: var(--text-primary);
  outline: none;
  transition:
    border-color var(--motion-duration-fast) var(--motion-ease),
    box-shadow var(--motion-duration-fast) var(--motion-ease);
}

.command-palette__input:focus {
  border-color: var(--selection-border);
  box-shadow: 0 0 0 var(--space-1) var(--selection-bg);
}

.command-palette__hint {
  margin-top: var(--space-2);
  font-size: 12px;
  color: var(--text-secondary);
}

.command-palette__list {
  margin: var(--space-3) 0 0;
  padding: 0;
  list-style: none;
  max-height: 340px;
  overflow: auto;
}

.command-palette__list:focus-visible {
  outline: var(--space-1) solid var(--selection-border);
  outline-offset: var(--space-1);
  border-radius: var(--radius);
}

.command-palette__group {
  margin: var(--space-3) 0 var(--space-2);
  padding: var(--space-0) var(--space-4);
  font-size: 11px;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: var(--text-secondary);
}

.command-palette__footer {
  margin-top: var(--space-3);
  font-size: 12px;
  color: var(--text-secondary);
  /* Keep a stable baseline height so the list doesn't jump when we toggle status text. */
  min-height: 16px;
}

.command-palette__footer[data-variant="warning"] {
  color: var(--warning);
}

.command-palette__item {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: var(--space-5);
  padding: var(--space-3) var(--space-4);
  border-radius: var(--radius);
  color: var(--text-primary);
  cursor: default;
}

.command-palette__item-icon {
  width: 20px;
  height: 20px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: var(--radius-sm);
  flex-shrink: 0;
  user-select: none;
}

.command-palette__item-icon--function {
  background: var(--success-bg);
  color: var(--success);
  font-weight: 600;
  font-family: var(--font-mono);
  font-size: 10px;
}

.command-palette__item-icon--command {
  background: var(--bg-inset);
  color: var(--text-secondary);
  font-size: 11px;
}

.command-palette__item-icon--goto {
  background: var(--accent-bg);
  color: var(--accent);
  font-size: 11px;
  font-weight: 600;
}

.command-palette__item-right {
  margin-left: auto;
  display: inline-flex;
}

.command-palette__item-main {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: var(--space-1);
}

.command-palette__item-right {
  flex: 0 0 auto;
  display: flex;
  align-items: center;
  justify-content: flex-end;
}

.command-palette__shortcut {
  display: inline-flex;
  align-items: center;
  padding: var(--space-1) var(--space-4);
  border-radius: var(--radius-pill);
  border: 1px solid var(--border);
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  font-size: 11px;
  letter-spacing: 0.02em;
}

.command-palette__selected-hint {
  display: none;
}

.command-palette__item[aria-selected="true"] .command-palette__selected-hint {
  display: inline-flex;
}

.command-palette__highlight {
  font-weight: 700;
}

.command-palette__empty {
  padding: var(--space-3) var(--space-4);
  color: var(--text-secondary);
}

.command-palette__item-label {
  font-weight: 600;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.command-palette__item-description {
  font-size: 12px;
  color: var(--text-secondary);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.command-palette__item-description--mono {
  font-family: var(--font-mono);
  font-size: 11px;
}

.command-palette__signature-name {
  color: var(--success);
  font-weight: 600;
}

.command-palette__item-shortcut {
  font-size: 12px;
  color: var(--text-secondary);
}

.command-palette__item[aria-selected="true"] {
  background: var(--selection-bg);
  color: var(--selection-text);
}

.command-palette__item[aria-selected="true"] .command-palette__item-description {
  color: var(--selection-text);
  opacity: 0.8;
}

/* --- Sheet tabs ---------------------------------------------------------- */

#sheet-tabs.sheet-bar {
  display: flex;
  align-items: center;
  gap: var(--space-1);
  padding: var(--space-0) var(--space-3);
  height: 24px;
  background: var(--bg-secondary);
  border-top: 1px solid var(--border);
  user-select: none;
  min-width: 0;
}

#sheet-tabs.sheet-bar:focus-within {
  outline: var(--space-1) solid var(--selection-border);
  outline-offset: calc(var(--space-1) * -1);
}

#sheet-tabs.sheet-bar .sheet-nav {
  display: flex;
  gap: var(--space-1);
  flex: 0 0 auto;
}

#sheet-tabs.sheet-bar .sheet-nav-btn,
#sheet-tabs.sheet-bar .sheet-add,
#sheet-tabs.sheet-bar .sheet-overflow {
  width: 22px;
  height: 22px;
  padding: 0;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border: none;
  border-radius: var(--radius-sm);
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  user-select: none;
}

#sheet-tabs.sheet-bar .sheet-nav-btn:hover,
#sheet-tabs.sheet-bar .sheet-add:hover,
#sheet-tabs.sheet-bar .sheet-overflow:hover {
  background: var(--bg-tertiary);
  color: var(--text-primary);
}

#sheet-tabs.sheet-bar .sheet-nav-btn:focus-visible,
#sheet-tabs.sheet-bar .sheet-add:focus-visible,
#sheet-tabs.sheet-bar .sheet-overflow:focus-visible {
  outline: var(--space-1) solid var(--selection-border);
  outline-offset: var(--space-1);
}

#sheet-tabs.sheet-bar .sheet-nav-btn:disabled {
  opacity: 0.45;
  cursor: default;
}

#sheet-tabs.sheet-bar .sheet-tabs {
  display: flex;
  gap: var(--space-1);
  flex: 1 1 auto;
  min-width: 0;
  overflow-x: auto;
  overflow-y: hidden;
  padding: var(--space-0) var(--space-1);
  background: transparent;
  border-top: none;
  align-items: flex-end;
  scroll-behavior: smooth;
}

html[data-reduced-motion="true"] #sheet-tabs.sheet-bar .sheet-tabs {
  scroll-behavior: auto;
}

@media (prefers-reduced-motion: reduce) {
  #sheet-tabs.sheet-bar .sheet-tabs {
    scroll-behavior: auto;
  }
}

#sheet-tabs.sheet-bar .sheet-tab {
  height: 22px;
  padding: 0;
  display: flex;
  align-items: flex-end;
  border: none;
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  white-space: nowrap;
  font-size: 12px;
  position: relative;
  flex: 0 0 auto;
}

#sheet-tabs.sheet-bar .sheet-tabs .sheet-tab:last-child {
  /* Fill the remaining tab strip width so dropping "after" the last tab still hits the tab element.
   * (This keeps Playwright dragTo stable while preserving the visual blank area using the inner pill.) */
  flex: 1 0 auto;
}

#sheet-tabs.sheet-bar .sheet-tab__pill {
  height: 22px;
  padding: var(--space-0) var(--space-5);
  display: inline-flex;
  align-items: center;
  position: relative;
  border: 1px solid var(--border);
  border-bottom: none;
  border-radius: var(--radius-sm) var(--radius-sm) 0 0;
  background: var(--bg-primary);
  color: inherit;
}

#sheet-tabs.sheet-bar .sheet-tabs[data-dragging="true"] .sheet-tab {
  cursor: grabbing;
}

#sheet-tabs.sheet-bar .sheet-tab[data-dragging="true"] {
  opacity: 0.65;
}

#sheet-tabs.sheet-bar .sheet-tab[data-drop-position="before"]::before {
  content: "";
  position: absolute;
  inset-block: var(--space-1);
  left: calc(var(--space-0) - var(--space-1));
  width: calc(var(--space-3) / 2);
  border-radius: var(--radius-pill);
  background: var(--accent);
}

#sheet-tabs.sheet-bar .sheet-tab[data-drop-position="after"]::after {
  content: "";
  position: absolute;
  inset-block: var(--space-1);
  right: calc(var(--space-0) - var(--space-1));
  width: calc(var(--space-3) / 2);
  border-radius: var(--radius-pill);
  background: var(--accent);
}

#sheet-tabs.sheet-bar .sheet-tab__pill--editing {
  padding: var(--space-0) var(--space-3);
}

#sheet-tabs.sheet-bar .sheet-tab:hover .sheet-tab__pill {
  background: var(--bg-tertiary);
}

#sheet-tabs.sheet-bar .sheet-tab[data-active="true"] .sheet-tab__pill {
  background: var(--accent-light);
  border-color: var(--accent);
  border-bottom: 1px solid var(--accent-light);
  margin-bottom: calc((var(--space-1) / 2) * -1);
  color: var(--text-primary);
  font-weight: 600;
}

#sheet-tabs.sheet-bar .sheet-tab:focus-visible {
  outline: none;
}

#sheet-tabs.sheet-bar .sheet-tab:focus-visible .sheet-tab__pill {
  outline: var(--space-1) solid var(--selection-border);
  outline-offset: var(--space-1);
}

#sheet-tabs.sheet-bar .sheet-tab__name {
  max-width: 180px;
  overflow: hidden;
  text-overflow: ellipsis;
}

#sheet-tabs.sheet-bar .sheet-tab__color {
  position: absolute;
  left: var(--space-3);
  right: var(--space-3);
  bottom: var(--space-1);
  height: calc(var(--space-3) / 2);
  border-radius: var(--radius-pill);
}

#sheet-tabs.sheet-bar .sheet-tab__input {
  width: 140px;
  max-width: 220px;
  height: 18px;
  padding: calc(var(--space-1) / 2) var(--space-3);
  font: inherit;
  background: var(--bg-primary);
  color: var(--text-primary);
  border: 1px solid var(--selection-border);
  border-radius: var(--radius-sm);
  outline: none;
}

#sheet-tabs.sheet-bar .sheet-tab__input[aria-invalid="true"] {
  border-color: var(--error);
  box-shadow: 0 0 0 calc(var(--space-1) / 2) var(--error);
}
