# Excel Oracle Compatibility Harness

This directory contains a **real Microsoft Excel** compatibility harness used to build an "oracle" dataset of expected formula results.

The intent is to continuously compare our formula engine against Excel across a growing, versioned corpus of cases.

## What this provides

- A deterministic, machine-readable **case corpus** (`tests/compatibility/excel-oracle/cases.json`)
- A Windows-only **Excel COM automation runner** that evaluates all cases in **real Excel** and exports results (`run-excel-oracle.ps1`)
- A **comparison tool** that diffs engine output vs Excel output and emits a mismatch report (`compare.py`)
- A GitHub Actions workflow (`.github/workflows/excel-compat.yml`) wired to run on `windows-latest`

## Prerequisites (local generation)

To generate oracle data locally you must have:

- Windows
- Microsoft Excel installed (desktop)
- PowerShell (Windows PowerShell 5.1 or PowerShell 7+)
- Python 3 (for comparison/reporting, optional if you only generate data)

## Case corpus

The canonical case list lives at:

`tests/compatibility/excel-oracle/cases.json`

It is generated by:

```powershell
python tools/excel-oracle/generate_cases.py --out tests/compatibility/excel-oracle/cases.json
```

The generator is deterministic; committing `cases.json` makes CI stable and reviewable.

## Generate oracle dataset from Excel

From repo root on Windows:

```powershell
powershell -ExecutionPolicy Bypass -File tools/excel-oracle/run-excel-oracle.ps1 `
  -CasesPath tests/compatibility/excel-oracle/cases.json `
  -OutPath tests/compatibility/excel-oracle/datasets/excel-oracle.json
```

The output JSON includes:

- Excel version/build metadata (because behavior can differ between Excel versions)
- A SHA-256 of the case corpus used
- Results encoded with a stable, typed representation (see below)

## Compare formula-engine output vs Excel oracle

1) Produce engine results JSON (same schema as Excel output). The intended flow is that your engine exposes a CLI that can evaluate the case corpus and emit results.

2) Compare:

```bash
python tools/excel-oracle/compare.py \
  --cases tests/compatibility/excel-oracle/cases.json \
  --expected tests/compatibility/excel-oracle/datasets/excel-oracle.json \
  --actual tests/compatibility/excel-oracle/datasets/engine-results.json \
  --report tests/compatibility/excel-oracle/reports/mismatch-report.json
```

The report includes `caseId`, `formula`, `inputs`, `expected`, `actual`, and a reason.

## Value encoding

Excel values are encoded to avoid ambiguity between:

- blank vs 0
- numbers vs error codes
- scalar vs spilled array results

See `tools/excel-oracle/value-encoding.md`.

## Schemas

JSON Schemas (for editor validation) live in `tools/excel-oracle/schemas/`.
