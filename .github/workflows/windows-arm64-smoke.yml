name: Windows ARM64 (Tauri) smoke

on:
  workflow_dispatch:
  schedule:
    # Weekly (Monday 05:23 UTC) so we detect runner image/toolchain regressions
    # even when no desktop-related PRs are landing.
    - cron: "23 5 * * 1"
  push:
    branches: [main]
    paths:
      - "apps/desktop/**"
      - "crates/**"
      - "packages/**"
      - "Cargo.lock"
      - ".github/workflows/windows-arm64-smoke.yml"
      - ".github/workflows/release.yml"
  pull_request:
    paths:
      - "apps/desktop/**"
      - "crates/**"
      - "packages/**"
      - "Cargo.lock"
      - ".github/workflows/windows-arm64-smoke.yml"
      - ".github/workflows/release.yml"

jobs:
  windows-arm64:
    name: Build + bundle (aarch64-pc-windows-msvc)
    # Avoid spending compute on scheduled runs in forks.
    if: github.event_name != 'schedule' || github.repository == 'wilson-anysphere/formula'
    runs-on: windows-latest

    env:
      # Keep this aligned with the pinned versions in `.github/workflows/release.yml`
      # so the smoke workflow catches the same toolchain regressions that would
      # break tagged releases.
      NODE_VERSION: 22
      PNPM_VERSION: 9.0.0
      WASM_PACK_VERSION: 0.13.1
      TAURI_CLI_VERSION: 2.9.5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: "Guard: Rust toolchain pins match rust-toolchain.toml"
        shell: bash
        run: bash scripts/ci/check-rust-toolchain-pins.sh

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Check pinned Tauri CLI version matches Tauri crates
        run: node scripts/ci/check-tauri-cli-version.mjs

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@1.92.0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Our dev scripts default to a repo-local CARGO_HOME to avoid cross-agent
      # contention on shared ~/.cargo. In GitHub Actions we prefer the default
      # CARGO_HOME so cargo installs/builds share the same cache.
      - name: Use shared Cargo home for CI caching
        shell: pwsh
        run: |
          $cargoHome = Join-Path $env:USERPROFILE ".cargo"
          "CARGO_HOME=$cargoHome" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Install Rust targets (wasm32 + Windows ARM64)
        run: rustup target add wasm32-unknown-unknown aarch64-pc-windows-msvc

      - name: Ensure MSVC ARM64 components are installed
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          if (!(Test-Path $vswhere)) {
            throw "vswhere not found at $vswhere (expected on windows-latest)."
          }
          $installPath = & $vswhere -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath
          if (!$installPath) {
            throw "Failed to locate a Visual Studio installation via vswhere."
          }
          Write-Host "Visual Studio install path: $installPath"
          $msvcRoot = Join-Path $installPath "VC\Tools\MSVC"
          $msvcVersionDir = Get-ChildItem -Path $msvcRoot -Directory | Sort-Object Name -Descending | Select-Object -First 1
          if (!$msvcVersionDir) {
            throw "MSVC toolset directory not found under $msvcRoot"
          }
          $arm64LibDir = Join-Path $msvcVersionDir.FullName "lib\arm64"
          $arm64BinDir = Join-Path $msvcVersionDir.FullName "bin\Hostx64\arm64"
          $arm64Cl = Join-Path $arm64BinDir "cl.exe"
          $arm64LinkExe = Join-Path $arm64BinDir "link.exe"
          $hasArm64Toolchain = (Test-Path $arm64LibDir) -and (Test-Path $arm64Cl) -and (Test-Path $arm64LinkExe)

          if (-not $hasArm64Toolchain) {
            Write-Host "MSVC ARM64 toolchain not found; installing Visual Studio component Microsoft.VisualStudio.Component.VC.Tools.ARM64"
            $vsInstaller = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vs_installer.exe"
            if (!(Test-Path $vsInstaller)) {
              throw "Visual Studio installer not found at $vsInstaller"
            }
            & $vsInstaller modify --installPath $installPath --add Microsoft.VisualStudio.Component.VC.Tools.ARM64 --includeRecommended --passive --norestart
            $exitCode = $LASTEXITCODE
            # 3010 is a common "success, reboot required" code for Windows installers.
            if ($exitCode -ne 0 -and $exitCode -ne 3010) {
              throw "vs_installer.exe failed with exit code $exitCode while installing MSVC ARM64 components."
            }

            $msvcVersionDir = Get-ChildItem -Path $msvcRoot -Directory | Sort-Object Name -Descending | Select-Object -First 1
            $arm64LibDir = Join-Path $msvcVersionDir.FullName "lib\arm64"
            $arm64BinDir = Join-Path $msvcVersionDir.FullName "bin\Hostx64\arm64"
            $arm64Cl = Join-Path $arm64BinDir "cl.exe"
            $arm64LinkExe = Join-Path $arm64BinDir "link.exe"
          }

          if (!(Test-Path $arm64LibDir) -or !(Test-Path $arm64Cl) -or !(Test-Path $arm64LinkExe)) {
            throw "MSVC ARM64 build tools were not found. Expected:\n  - $arm64LibDir\n  - $arm64Cl\n  - $arm64LinkExe\nGitHub-hosted runners may not include the required MSVC ARM64 workload; use a self-hosted runner with ARM64 build tools preinstalled."
          }

          Write-Host "MSVC ARM64 tools present:"
          Write-Host "  - libs: $arm64LibDir"
          Write-Host "  - cl.exe: $arm64Cl"
          Write-Host "  - link.exe: $arm64LinkExe"

          $sdkLibRoot = Join-Path ${env:ProgramFiles(x86)} "Windows Kits\10\Lib"
          if (!(Test-Path $sdkLibRoot)) {
            throw "Windows SDK lib root not found at $sdkLibRoot. Windows ARM64 builds require the Windows 10/11 SDK with ARM64 libraries."
          }

          $sdkVersionDir = Get-ChildItem -Path $sdkLibRoot -Directory -ErrorAction SilentlyContinue | Sort-Object Name -Descending | Select-Object -First 1
          if (!$sdkVersionDir) {
            throw "No Windows SDK lib versions found under $sdkLibRoot. Windows ARM64 builds require a Windows SDK installation with ARM64 libraries."
          }

          $sdkUmArm64 = Join-Path $sdkVersionDir.FullName "um\arm64"
          $sdkUcrtArm64 = Join-Path $sdkVersionDir.FullName "ucrt\arm64"
          if (!(Test-Path $sdkUmArm64)) {
            throw "Windows SDK ARM64 UM libraries not found at $sdkUmArm64. The runner image may be missing the Windows SDK ARM64 components."
          }
          if (!(Test-Path $sdkUcrtArm64)) {
            throw "Windows SDK ARM64 UCRT libraries not found at $sdkUcrtArm64. The runner image may be missing the Windows SDK ARM64 components."
          }

          Write-Host "windows-arm64-toolchain: OK"
          Write-Host " - MSVC: $($msvcVersionDir.FullName)"
          Write-Host " - link.exe: $arm64LinkExe"
          Write-Host " - MSVC lib: $arm64LibDir"
          Write-Host " - SDK um/arm64: $sdkUmArm64"
          Write-Host " - SDK ucrt/arm64: $sdkUcrtArm64"

      - name: Install WiX Toolset (required for MSI builds)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $candle = Get-Command candle.exe -ErrorAction SilentlyContinue
          $light = Get-Command light.exe -ErrorAction SilentlyContinue
          if (-not $candle -or -not $light) {
            choco install wixtoolset --yes --no-progress
            if (Test-Path "$env:ChocolateyInstall\\helpers\\chocolateyProfile.psm1") {
              Import-Module "$env:ChocolateyInstall\\helpers\\chocolateyProfile.psm1"
              refreshenv
            }
          }

          # Add common WiX install locations to PATH for subsequent steps.
          $wixRoots = Get-ChildItem -Path (Join-Path ${env:ProgramFiles(x86)} "WiX Toolset v*") -Directory -ErrorAction SilentlyContinue
          foreach ($root in $wixRoots) {
            $bin = Join-Path $root.FullName "bin"
            if (Test-Path $bin) {
              $env:PATH = "$bin;$env:PATH"
              $bin | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
            }
          }

          if (-not (Get-Command candle.exe -ErrorAction SilentlyContinue)) {
            throw "WiX Toolset installation failed: candle.exe not found on PATH."
          }
          if (-not (Get-Command light.exe -ErrorAction SilentlyContinue)) {
            throw "WiX Toolset installation failed: light.exe not found on PATH."
          }

      - name: Install NSIS (required for NSIS .exe bundling)
        shell: pwsh
        run: |
          choco install nsis --no-progress -y
          $nsisHome = "${env:ProgramFiles(x86)}\NSIS"
          if (Test-Path $nsisHome) {
            $nsisHome | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
          }

      - name: Install JS dependencies
        run: pnpm install --frozen-lockfile

      - name: Cache wasm-pack binary
        id: wasm-pack-cache
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/wasm-pack*
          key: wasm-pack-${{ runner.os }}-${{ runner.arch }}-v${{ env.WASM_PACK_VERSION }}
          restore-keys: |
            wasm-pack-${{ runner.os }}-${{ runner.arch }}-

      - name: Install wasm-pack (required for @formula/engine WASM build)
        if: steps.wasm-pack-cache.outputs.cache-hit != 'true'
        run: cargo install wasm-pack --version ${{ env.WASM_PACK_VERSION }} --locked

      - name: Cache pinned Tauri CLI binary (cargo-tauri)
        id: tauri-cli-cache
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-tauri*
          key: cargo-tauri-${{ runner.os }}-${{ runner.arch }}-v${{ env.TAURI_CLI_VERSION }}
          restore-keys: |
            cargo-tauri-${{ runner.os }}-${{ runner.arch }}-

      - name: Install tauri-cli (installs the `cargo tauri` subcommand)
        if: steps.tauri-cli-cache.outputs.cache-hit != 'true'
        run: cargo install tauri-cli --version ${{ env.TAURI_CLI_VERSION }} --locked --force

      - name: Print Tauri CLI version
        run: cargo tauri --version

      - name: Cache Tauri tooling downloads
        uses: actions/cache@v4
        with:
          # Tauri's cache directory lives under %LOCALAPPDATA% on Windows.
          path: ${{ env.LOCALAPPDATA }}/tauri
          key: tauri-tooling-${{ runner.os }}-${{ runner.arch }}-v${{ env.TAURI_CLI_VERSION }}
          restore-keys: |
            tauri-tooling-${{ runner.os }}-${{ runner.arch }}-

      - name: Setup MSVC cross-compilation environment (amd64 â†’ arm64)
        uses: ilammy/msvc-dev-cmd@7defe9254715b088f12dddd9942945a3d75cdad5 # v1.9.0
        with:
          arch: amd64_arm64

      - name: Build Windows ARM64 bundles (MSI + NSIS)
        run: |
          cd apps/desktop
          cargo tauri build --target aarch64-pc-windows-msvc --bundles msi,nsis

      - name: Verify compiled desktop executable is ARM64
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $target = "aarch64-pc-windows-msvc"
          $releaseDir = "apps/desktop/src-tauri/target/$target/release"
          if (!(Test-Path $releaseDir)) {
            throw "Expected Rust release directory not found: $releaseDir"
          }
          $exe = Get-ChildItem -Path $releaseDir -Recurse -File -Filter "formula-desktop.exe" | Select-Object -First 1
          if (-not $exe) {
            throw "Expected compiled binary formula-desktop.exe not found under: $releaseDir"
          }
          $dumpbin = Get-Command dumpbin.exe -ErrorAction SilentlyContinue
          if (-not $dumpbin) {
            throw "dumpbin.exe not found on PATH (expected after MSVC dev-cmd setup)."
          }
          $headers = & dumpbin.exe /headers $exe.FullName
          $joined = ($headers -join "`n")
          $machineLine = ($headers | Select-String -Pattern "machine" -CaseSensitive:$false | Select-Object -First 1).ToString()
          Write-Host "dumpbin machine line: $machineLine"
          if ($joined -notmatch "machine \\(AA64\\)") {
            throw "Expected ARM64 machine type (AA64) in PE headers for $($exe.FullName). If this is x64, the ARM64 target toolchain/environment is misconfigured."
          }

      - name: Verify bundles exist
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $bundleDir = "apps/desktop/src-tauri/target/aarch64-pc-windows-msvc/release/bundle"
          if (!(Test-Path $bundleDir)) {
            throw "Expected bundle directory not found: $bundleDir"
          }

          # Mirror the release workflow's Windows bundle detection so we don't pass just because
          # helper executables (e.g. WebView2 bootstrapper) landed somewhere under bundle/.
          $msi = @(Get-ChildItem -Path (Join-Path $bundleDir "msi") -Recurse -File -Filter "*.msi" -ErrorAction SilentlyContinue)
          $exe = @()
          $exe += @(Get-ChildItem -Path (Join-Path $bundleDir "nsis") -Recurse -File -Filter "*.exe" -ErrorAction SilentlyContinue)
          $exe += @(Get-ChildItem -Path (Join-Path $bundleDir "nsis-web") -Recurse -File -Filter "*.exe" -ErrorAction SilentlyContinue)
          # Exclude WebView2 helper installers; we only care about the Formula installer(s).
          $exe = @($exe | Where-Object { $_.Name -notmatch '^MicrosoftEdgeWebview2' })

          if ($exe.Count -eq 0) { throw "No .exe installer found under $bundleDir/nsis or $bundleDir/nsis-web (expected NSIS)." }
          if ($msi.Count -eq 0) { throw "No .msi installer found under $bundleDir/msi (expected WiX)." }

          "## Windows ARM64 bundles" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $files = @($exe + $msi) | Sort-Object FullName
          foreach ($f in $files) {
            $rel = $f.FullName.Replace((Resolve-Path ".").Path + "\", "")
            $mb = [Math]::Round($f.Length / 1MB, 2)
            "- `$rel` (${mb} MB)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          }

      - name: Verify Windows installers bundle/reference WebView2 (bootstrapper/runtime)
        run: python scripts/ci/check-windows-webview2-installer.py

      - name: Upload bundles
        uses: actions/upload-artifact@v4
        with:
          name: windows-arm64-bundles
          path: apps/desktop/src-tauri/target/aarch64-pc-windows-msvc/release/bundle/**
