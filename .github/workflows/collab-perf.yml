name: Collab perf (manual)

on:
  workflow_dispatch:
    inputs:
      suite:
        description: "Which perf suite to run"
        required: true
        default: "both"
        type: choice
        options:
          - binder
          - session
          - both
      scenario:
        description: "Which scenario to run (affects PERF_SCENARIO)"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - yjs-to-dc
          - dc-to-yjs
      cell_updates:
        description: "PERF_CELL_UPDATES"
        required: true
        default: "50000"
      batch_size:
        description: "PERF_BATCH_SIZE"
        required: true
        default: "1000"
      cols:
        description: "PERF_COLS"
        required: true
        default: "100"
      key_encoding:
        description: "PERF_KEY_ENCODING (Yjs->DC scenario)"
        required: true
        default: "canonical"
        type: choice
        options:
          - canonical
          - legacy
          - rxc
      include_format:
        description: "PERF_INCLUDE_FORMAT (1 to include format/style updates)"
        required: true
        default: "0"
        type: choice
        options:
          - "0"
          - "1"
      include_guards:
        description: "PERF_INCLUDE_GUARDS (binder perf only; 0 disables canRead/canEdit hooks)"
        required: true
        default: "1"
        type: choice
        options:
          - "1"
          - "0"
      format_variants:
        description: "PERF_FORMAT_VARIANTS (distinct formats cycled when PERF_INCLUDE_FORMAT=1)"
        required: true
        default: "4"
      timeout_ms:
        description: "PERF_TIMEOUT_MS (internal wait/test timeout)"
        required: true
        default: "600000"

concurrency:
  group: collab-perf-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: 22
  # Best-effort memory measurements rely on `global.gc()`.
  NODE_OPTIONS: --expose-gc
  PERF_JSON: "1"
  PERF_SCENARIO: ${{ inputs.scenario }}
  PERF_CELL_UPDATES: ${{ inputs.cell_updates }}
  PERF_BATCH_SIZE: ${{ inputs.batch_size }}
  PERF_COLS: ${{ inputs.cols }}
  PERF_KEY_ENCODING: ${{ inputs.key_encoding }}
  PERF_INCLUDE_FORMAT: ${{ inputs.include_format }}
  PERF_INCLUDE_GUARDS: ${{ inputs.include_guards }}
  PERF_FORMAT_VARIANTS: ${{ inputs.format_variants }}
  PERF_TIMEOUT_MS: ${{ inputs.timeout_ms }}
  # Keep the node:test runner conservative for perf stability.
  FORMULA_NODE_TEST_CONCURRENCY: "1"

jobs:
  collab-perf:
    runs-on: ubuntu-24.04
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4
        with:
          version: 9.0.0

      - name: Setup Node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Install JS dependencies
        run: pnpm install --frozen-lockfile

      - name: Run binder perf
        if: inputs.suite == 'binder' || inputs.suite == 'both'
        env:
          FORMULA_RUN_COLLAB_BINDER_PERF: "1"
        run: |
          set -euo pipefail
          pnpm test:node packages/collab/binder/test/perf/binder-perf.test.js | tee binder-perf.log

      - name: Run session+binder perf
        if: inputs.suite == 'session' || inputs.suite == 'both'
        env:
          FORMULA_RUN_COLLAB_SESSION_BINDER_PERF: "1"
        run: |
          set -euo pipefail
          pnpm test:node packages/collab/session/test/perf/session-binder-perf.test.js | tee session-binder-perf.log

      - name: Upload perf logs
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: collab-perf-logs
          path: |
            binder-perf.log
            session-binder-perf.log
