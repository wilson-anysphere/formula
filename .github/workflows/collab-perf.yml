name: Collab perf (manual)

on:
  workflow_dispatch:
    inputs:
      suite:
        description: "Which perf suite to run"
        required: true
        default: "both"
        type: choice
        options:
          - binder
          - session
          - both
      scenario:
        description: "Which scenario to run (affects PERF_SCENARIO)"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - yjs-to-dc
          - dc-to-yjs
      cell_updates:
        description: "PERF_CELL_UPDATES"
        required: true
        default: "50000"
      batch_size:
        description: "PERF_BATCH_SIZE"
        required: true
        default: "1000"
      cols:
        description: "PERF_COLS"
        required: true
        default: "100"
      key_encoding:
        description: "PERF_KEY_ENCODING (Yjs->DC scenario)"
        required: true
        default: "canonical"
        type: choice
        options:
          - canonical
          - legacy
          - rxc
      include_format:
        description: "PERF_INCLUDE_FORMAT (1 to include format/style updates)"
        required: true
        default: "0"
        type: choice
        options:
          - "0"
          - "1"
      include_guards:
        description: "PERF_INCLUDE_GUARDS (binder perf only; 0 disables canRead/canEdit hooks)"
        required: true
        default: "1"
        type: choice
        options:
          - "1"
          - "0"
      format_variants:
        description: "PERF_FORMAT_VARIANTS (distinct formats cycled when PERF_INCLUDE_FORMAT=1)"
        required: true
        default: "4"
      timeout_ms:
        description: "PERF_TIMEOUT_MS (internal wait/test timeout)"
        required: true
        default: "600000"

concurrency:
  group: collab-perf-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: 22
  # Best-effort memory measurements rely on `global.gc()`.
  NODE_OPTIONS: --expose-gc
  PERF_JSON: "1"
  PERF_SCENARIO: ${{ inputs.scenario }}
  PERF_CELL_UPDATES: ${{ inputs.cell_updates }}
  PERF_BATCH_SIZE: ${{ inputs.batch_size }}
  PERF_COLS: ${{ inputs.cols }}
  PERF_KEY_ENCODING: ${{ inputs.key_encoding }}
  PERF_INCLUDE_FORMAT: ${{ inputs.include_format }}
  PERF_INCLUDE_GUARDS: ${{ inputs.include_guards }}
  PERF_FORMAT_VARIANTS: ${{ inputs.format_variants }}
  PERF_TIMEOUT_MS: ${{ inputs.timeout_ms }}
  # Keep the node:test runner conservative for perf stability.
  FORMULA_NODE_TEST_CONCURRENCY: "1"

jobs:
  collab-perf:
    runs-on: ubuntu-24.04
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4
        with:
          version: 9.0.0

      - name: Setup Node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Install JS dependencies
        run: pnpm install --frozen-lockfile

      - name: Run binder perf
        id: binder_perf
        if: inputs.suite == 'binder' || inputs.suite == 'both'
        continue-on-error: true
        env:
          FORMULA_RUN_COLLAB_BINDER_PERF: "1"
        run: |
          set -euo pipefail
          pnpm test:node packages/collab/binder/test/perf/binder-perf.test.js | tee binder-perf.log

      - name: Run session+binder perf
        id: session_perf
        if: inputs.suite == 'session' || inputs.suite == 'both'
        continue-on-error: true
        env:
          FORMULA_RUN_COLLAB_SESSION_BINDER_PERF: "1"
        run: |
          set -euo pipefail
          pnpm test:node packages/collab/session/test/perf/session-binder-perf.test.js | tee session-binder-perf.log

      - name: Write perf summary
        if: always()
        run: |
          node - <<'NODE'
          const fs = require("node:fs");
          const summaryPath = process.env.GITHUB_STEP_SUMMARY;
          if (!summaryPath) process.exit(0);
          
          const results = [];
          for (const file of ["binder-perf.log", "session-binder-perf.log"]) {
            if (!fs.existsSync(file)) continue;
            const lines = fs.readFileSync(file, "utf8").split(/\r?\n/);
            for (const line of lines) {
              const trimmed = line.trim();
              if (!trimmed.startsWith("{") || !trimmed.endsWith("}")) continue;
              try {
                const obj = JSON.parse(trimmed);
                if (!obj || typeof obj !== "object") continue;
                if (typeof obj.suite !== "string" || typeof obj.scenario !== "string") continue;
                results.push(obj);
              } catch {
                // ignore
              }
            }
          }
          
          if (results.length === 0) {
            fs.appendFileSync(summaryPath, "\n## Collab perf summary\n\n(no PERF_JSON output found in logs)\n");
            process.exit(0);
          }
          
          const runtime = results.find((r) => r && typeof r === "object" && r.runtime)?.runtime ?? null;
          const fmtMiB = (bytes) => (Number.isFinite(bytes) ? (bytes / 1024 / 1024).toFixed(1) : "");
          const fmtMs = (ms) => (Number.isFinite(ms) ? Number(ms).toFixed(1) : "");
          
          let md = "\n## Collab perf summary\n\n";
          if (runtime && typeof runtime === "object") {
            md += `- runtime: ${runtime.node ?? ""} (${runtime.platform ?? ""}/${runtime.arch ?? ""})\n\n`;
          }
          
          md +=
            "| suite | scenario | updates | batch | cols | keyEnc | format | guards | total ms | peak heap (MiB) | peak rss (MiB) |\n" +
            "| --- | --- | ---: | ---: | ---: | --- | --- | --- | ---: | ---: | ---: |\n";
          
          for (const r of results) {
            const timing = r.timingMs ?? {};
            const mem = r.mem ?? {};
            const totalMs = timing.total;
            const heapPeak = mem.heapUsed?.peak;
            const rssPeak = mem.rss?.peak;
            const format = r.format ? `variants=${r.format.variants ?? ""}` : "";
            const guards = r.guards == null ? "" : String(r.guards);
            md += `| ${r.suite} | ${r.scenario} | ${r.updates ?? ""} | ${r.batchSize ?? ""} | ${r.cols ?? ""} | ${r.keyEncoding ?? ""} | ${format} | ${guards} | ${fmtMs(totalMs)} | ${fmtMiB(heapPeak)} | ${fmtMiB(rssPeak)} |\n`;
          }
          
          md += "\n";
          fs.appendFileSync(summaryPath, md);
          NODE

      - name: Upload perf logs
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: collab-perf-logs
          path: |
            binder-perf.log
            session-binder-perf.log
          if-no-files-found: ignore

      - name: Fail if perf benchmarks failed
        if: always()
        run: |
          if [[ "${{ steps.binder_perf.outcome }}" == "failure" || "${{ steps.session_perf.outcome }}" == "failure" ]]; then
            echo "One or more collab perf steps failed." >&2
            echo "binder_perf:  ${{ steps.binder_perf.outcome }}" >&2
            echo "session_perf: ${{ steps.session_perf.outcome }}" >&2
            exit 1
          fi
