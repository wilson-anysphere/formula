name: CI

on:
  push:
    branches: [main]
  pull_request:

env:
  # Pin CI Node.js major (keep in sync with release.yml) to reduce drift between
  # what CI tests and what tagged releases build.
  NODE_VERSION: 22
  # Keep in sync with release.yml so CI catches WASM toolchain issues early.
  WASM_PACK_VERSION: 0.13.1
  # Keep in sync with the `tauri` dependency pinned in Cargo.lock (and the pinned
  # TAURI_CLI_VERSION in release.yml) so CI catches toolchain drift early.
  TAURI_CLI_VERSION: 2.9.5

jobs:
  conflict-marker-guard:
    name: "Guard: no merge conflict markers"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Fail if merge conflict markers are present
        run: bash scripts/ci/check-merge-conflict-markers.sh
      - name: "Guard: Rust toolchain pins match rust-toolchain.toml"
        run: bash scripts/ci/check-rust-toolchain-pins.sh

  xlsx-roundtrip:
    name: XLSX round-trip fixtures
    needs: conflict-marker-guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.92.0
      - name: Run xlsx-diff tests (includes fixture harness)
        run: cargo test -p xlsx-diff --locked
      - name: Run formula-xlsx tests
        run: cargo test -p formula-xlsx --locked
      - name: Run formula-xls tests
        run: cargo test -p formula-xls --locked

  desktop-backend-tests:
    name: Desktop backend (Rust) tests
    needs: conflict-marker-guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.92.0
      # Our dev scripts default to a repo-local CARGO_HOME to avoid cross-agent
      # contention on shared ~/.cargo. In GitHub Actions we prefer the default
      # CARGO_HOME so cargo installs and builds share the same cache.
      - name: Use shared Cargo home for CI caching
        run: echo "CARGO_HOME=$HOME/.cargo" >> "$GITHUB_ENV"
      - name: Run desktop backend tests (no WebView toolchain)
        # NOTE: Do NOT enable the `desktop` feature here. That feature pulls in
        # the system WebView toolchain (gtk/webkit2gtk) on Linux, which is not
        # required for backend unit/integration tests.
        run: |
          # The desktop backend crate was historically named `formula-desktop-tauri`;
          # it has since been renamed to `desktop`. Run whichever exists so CI
          # keeps covering backend logic without requiring the WebView toolchain.
          if cargo metadata --no-deps --format-version=1 | grep -q '"name":"formula-desktop-tauri"'; then
            cargo test -p formula-desktop-tauri --locked
          else
            cargo test -p desktop --locked
          fi

  excel-oracle-compat:
    name: Excel oracle compatibility (pinned)
    needs: conflict-marker-guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.92.0
      # Our dev scripts default to a repo-local CARGO_HOME to avoid cross-agent
      # contention on shared ~/.cargo. In GitHub Actions we prefer the default
      # CARGO_HOME so cargo installs and builds share the same cache.
      - name: Use shared Cargo home for CI caching
        run: echo "CARGO_HOME=$HOME/.cargo" >> "$GITHUB_ENV"
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Run excel-oracle python unit tests
        run: python -m unittest discover -s tools/excel-oracle/tests
      - name: Run excel-oracle corpus coverage guards
        run: cargo test -p formula-engine --test excel_oracle_coverage --test function_catalog_sync --test locale_function_tsv_completeness --locked
      - name: Run compatibility gate (engine vs pinned Excel dataset)
        run: python tools/excel-oracle/compat_gate.py
      - name: Publish compatibility summary
        if: always()
        run: |
          if [ -f tests/compatibility/excel-oracle/reports/summary.md ]; then
            cat tests/compatibility/excel-oracle/reports/summary.md >> "$GITHUB_STEP_SUMMARY"
          fi
      - name: Upload excel-oracle artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: excel-oracle-compat
          path: |
            tests/compatibility/excel-oracle/datasets/engine-results.json
            tests/compatibility/excel-oracle/reports/mismatch-report.json
            tests/compatibility/excel-oracle/reports/summary.md

  web:
    name: Web + desktop builds
    needs: conflict-marker-guard
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Setup Rust toolchain (wasm32)
        uses: dtolnay/rust-toolchain@1.92.0
        with:
          targets: wasm32-unknown-unknown

      # Our dev scripts default to a repo-local CARGO_HOME to avoid cross-agent
      # contention on shared ~/.cargo. In GitHub Actions we prefer the default
      # CARGO_HOME so cargo installs and wasm-pack builds share the same cache.
      - name: Use shared Cargo home for CI caching
        run: echo "CARGO_HOME=$HOME/.cargo" >> "$GITHUB_ENV"

      - name: Check formula-engine builds for wasm32
        run: cargo check -p formula-engine --target wasm32-unknown-unknown --all-targets --locked

      - name: Check formula-engine builds for wasm32 (no default features)
        run: cargo check -p formula-engine --target wasm32-unknown-unknown --no-default-features --all-targets --locked

      - name: Check formula-vba builds for wasm32
        run: cargo check -p formula-vba --target wasm32-unknown-unknown --all-targets --locked

      - name: Check formula-offcrypto builds for wasm32
        run: cargo check -p formula-offcrypto --target wasm32-unknown-unknown --all-targets --locked

      - name: Check formula-wasm builds for wasm32
        run: cargo check -p formula-wasm --target wasm32-unknown-unknown --all-targets --locked

      - name: Cache wasm-pack binary
        id: wasm-pack-cache
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/wasm-pack
          key: wasm-pack-${{ runner.os }}-${{ runner.arch }}-v${{ env.WASM_PACK_VERSION }}
          restore-keys: |
            wasm-pack-${{ runner.os }}-${{ runner.arch }}-

      - name: Install wasm-pack
        if: steps.wasm-pack-cache.outputs.cache-hit != 'true'
        # Pinned to match the tagged release workflow so CI catches WASM toolchain
        # incompatibilities before we cut a release.
        run: cargo install wasm-pack --version ${{ env.WASM_PACK_VERSION }} --locked

      - name: Verify wasm-pack version
        shell: bash
        run: |
          set -euo pipefail
          expected="${WASM_PACK_VERSION}"
          actual="$(wasm-pack --version | tr -d '\r' | awk '{print $2}')"
          if [[ "${actual}" != "${expected}" ]]; then
            echo "Expected wasm-pack ${expected}, but found ${actual}." >&2
            exit 1
          fi

      - name: Build WASM bundle (wasm-pack)
        # Build before `pnpm install` so we fail fast on Rust/WASM toolchain issues
        # without paying the JS dependency install cost.
        run: node packages/engine/scripts/build-wasm.mjs

      - name: Run formula-wasm wasm-bindgen tests (node)
        # Ensure our wasm-bindgen exports (including optional engines like formula-dax)
        # remain usable in JS runtimes.
        run: wasm-pack test crates/formula-wasm --node --release

      - name: Smoke-check WASM assets (no pnpm install)
        run: node packages/engine/scripts/smoke-wasm.mjs

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint (Node-free desktop renderer guard)
        run: pnpm -w lint

      - name: Build web
        run: pnpm build:web

      - name: Build desktop (Vite)
        run: pnpm build:desktop

      - name: Desktop dist asset report
        run: node scripts/desktop_dist_asset_report.mjs
        env:
          # Optional: define these as GitHub Actions "Variables" to enable gating without
          # changing the workflow. Leaving them unset (or empty) keeps the report informational.
          FORMULA_DESKTOP_DIST_TOTAL_BUDGET_MB: ${{ vars.FORMULA_DESKTOP_DIST_TOTAL_BUDGET_MB }}
          FORMULA_DESKTOP_DIST_SINGLE_FILE_BUDGET_MB: ${{ vars.FORMULA_DESKTOP_DIST_SINGLE_FILE_BUDGET_MB }}

      - name: Check desktop bundle size budgets
        run: pnpm -C apps/desktop check:bundle-size
        env:
          # Budgets are interpreted as KiB (1024 bytes). Adjust intentionally when
          # landing changes that affect the initial load footprint.
          FORMULA_DESKTOP_JS_TOTAL_BUDGET_KB: "5000"
          FORMULA_DESKTOP_JS_ENTRY_BUDGET_KB: "3300"

      - name: Smoke-check WASM assets
        run: pnpm smoke:wasm

      - name: Install Linux dependencies (Tauri/WebView)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libssl-dev \
            patchelf

      - name: Build desktop binary (Rust, release)
        run: cargo build -p formula-desktop-tauri --features desktop --release --locked

      - name: Desktop size report (binary + dist)
        env:
          # Optional: define these as GitHub Actions "Variables" to enable gating without
          # changing the workflow. Leaving them unset (or empty) keeps the report informational.
          FORMULA_DESKTOP_BINARY_SIZE_LIMIT_MB: ${{ vars.FORMULA_DESKTOP_BINARY_SIZE_LIMIT_MB }}
          FORMULA_DESKTOP_DIST_SIZE_LIMIT_MB: ${{ vars.FORMULA_DESKTOP_DIST_SIZE_LIMIT_MB }}
        run: python scripts/desktop_size_report.py --binary target/release/formula-desktop --dist apps/desktop/dist --json-out desktop-size-report.json

      - name: Upload desktop size report (JSON)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: desktop-size-report
          path: desktop-size-report.json
          if-no-files-found: ignore

  desktop-tauri-check:
    name: Desktop (Tauri) Rust compile check
    needs: conflict-marker-guard
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.92.0
      - name: Setup Node (for Tauri permission validation script)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      # Our dev scripts default to a repo-local CARGO_HOME to avoid cross-agent
      # contention on shared ~/.cargo. In GitHub Actions we prefer the default
      # CARGO_HOME so cargo installs/builds share the same cache.
      - name: Use shared Cargo home for CI caching
        run: echo "CARGO_HOME=$HOME/.cargo" >> "$GITHUB_ENV"
      - name: Install Linux dependencies (Tauri/WebView)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libssl-dev \
            patchelf
      - name: Cache cargo-tauri binary
        id: cargo-tauri-cache
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-tauri
          key: cargo-tauri-${{ runner.os }}-${{ runner.arch }}-v${{ env.TAURI_CLI_VERSION }}
          restore-keys: |
            cargo-tauri-${{ runner.os }}-${{ runner.arch }}-
      - name: Install pinned tauri-cli (cargo tauri)
        if: steps.cargo-tauri-cache.outputs.cache-hit != 'true'
        run: bash scripts/cargo_agent.sh install tauri-cli --version "${TAURI_CLI_VERSION}" --locked --force
      - name: Verify cargo-tauri version
        shell: bash
        run: |
          set -euo pipefail
          expected="${TAURI_CLI_VERSION}"
          actual="$(cargo-tauri --version | tr -d '\r' | awk '{print $2}')"
          echo "cargo-tauri version: ${actual}"
          if [[ "${actual}" != "${expected}" ]]; then
            echo "Expected cargo-tauri ${expected}, but found ${actual}." >&2
            exit 1
          fi
      - name: Validate Tauri capability permission identifiers
        run: node scripts/check-tauri-permissions.mjs
      - name: Check desktop shell builds with full desktop feature set
        run: |
          # The desktop shell crate was historically named `desktop`. It is now
          # `formula-desktop-tauri` (with the Rust library crate kept as `desktop`
          # so internal `use desktop::...` imports still work).
          if cargo metadata --no-deps --format-version=1 | grep -q '"name":"formula-desktop-tauri"'; then
            cargo check -p formula-desktop-tauri --features desktop --locked
          else
            cargo check -p desktop --features desktop --locked
          fi

  desktop-tauri-check-windows:
    name: Desktop (Tauri) Rust compile check (Windows)
    needs: conflict-marker-guard
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.92.0
      # Our dev scripts default to a repo-local CARGO_HOME to avoid cross-agent
      # contention on shared ~/.cargo. In GitHub Actions we prefer the default
      # CARGO_HOME so cargo installs/builds share the same cache.
      - name: Use shared Cargo home for CI caching
        # PowerShell file redirection can emit UTF-16; explicitly write UTF-8 so
        # GitHub Actions can parse the environment file.
        run: echo "CARGO_HOME=$HOME/.cargo" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      - name: Check desktop builds with full desktop feature set
        run: |
          if (cargo metadata --no-deps --format-version=1 | Select-String -Pattern '"name":"formula-desktop-tauri"' -Quiet) {
            cargo check -p formula-desktop-tauri --features desktop
          } else {
            cargo check -p desktop --features desktop
          }

  desktop-tauri-check-macos:
    name: Desktop (Tauri) Rust compile check (macOS)
    needs: conflict-marker-guard
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node (for static preflight scripts)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Validate macOS entitlements (hardened runtime)
        run: node scripts/check-macos-entitlements.mjs
      - uses: dtolnay/rust-toolchain@1.92.0
      # Our dev scripts default to a repo-local CARGO_HOME to avoid cross-agent
      # contention on shared ~/.cargo. In GitHub Actions we prefer the default
      # CARGO_HOME so cargo installs/builds share the same cache.
      - name: Use shared Cargo home for CI caching
        run: echo "CARGO_HOME=$HOME/.cargo" >> "$GITHUB_ENV"
      - name: Check desktop builds with full desktop feature set
        run: |
          if cargo metadata --no-deps --format-version=1 | grep -q '"name":"formula-desktop-tauri"'; then
            cargo check -p formula-desktop-tauri --features desktop
          else
            cargo check -p desktop --features desktop
          fi

  node-tests:
    name: Node tests
    needs: conflict-marker-guard
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run node:test suite
        run: pnpm test:node

  tab-completion-latency-guard:
    name: TabCompletionEngine latency guard
    needs: conflict-marker-guard
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run TabCompletionEngine micro-benchmark
        run: node packages/ai-completion/bench/tabCompletionEngine.bench.mjs --ci

  desktop-tauri-guardrails:
    name: Desktop (Tauri) frontend guardrail tests
    needs: conflict-marker-guard
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: "Guard: Windows Authenticode timestamp URL uses HTTPS"
        run: node scripts/ci/check-windows-timestamp-url.mjs

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run desktop Tauri guardrail Vitest suite (capabilities/event allowlists + IPC readiness)
        env:
          # These tests only parse JSON/config and source files; skip the repo-wide
          # wasm-pack build performed by scripts/vitest.global-setup.mjs.
          FORMULA_SKIP_WASM_BUILD: "1"
        # NOTE: Do not include an extra `--` after the script name. Vitest treats it as
        # an argument separator and will fall back to running the full test suite.
        run: pnpm test:vitest apps/desktop/src/tauri/__tests__/eventPermissions.vitest.ts apps/desktop/src/tauri/__tests__/capabilitiesPermissions.vitest.ts apps/desktop/src/tauri/__tests__/tauriSecurityConfig.vitest.ts apps/desktop/src/tauri/__tests__/openFileIpc.vitest.ts apps/desktop/src/tauri/__tests__/openFileIpcWiring.vitest.ts

  sync-server-docker:
    name: Sync server Docker build
    needs: conflict-marker-guard
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node (for JSON parsing in smoke tests)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build sync-server image
        run: docker build --build-arg npm_config_build_from_source=true -f services/sync-server/Dockerfile . -t formula-sync-server:ci

      - name: Smoke test container
        run: |
          set -euo pipefail
          docker volume create sync-server-ci-data-leveldb > /dev/null
          docker run -d \
            -p 12345:1234 \
            -e SYNC_SERVER_AUTH_TOKEN=ci-token \
            -e SYNC_SERVER_DATA_DIR=/data \
            -v sync-server-ci-data-leveldb:/data \
            --name sync-server \
            formula-sync-server:ci

          cleanup() {
            docker logs sync-server --tail 200 || true
            docker rm -f sync-server || true
            docker volume rm -f sync-server-ci-data-leveldb || true
          }
          trap cleanup EXIT

          for i in {1..30}; do
            if curl -fsS http://127.0.0.1:12345/healthz > /dev/null; then
              break
            fi
            sleep 1
          done

          curl -fsS http://127.0.0.1:12345/healthz | node -e "const fs=require('fs');const j=JSON.parse(fs.readFileSync(0,'utf8'));console.log(JSON.stringify(j));if(j.backend!=='leveldb'){throw new Error('expected backend=leveldb');}if(j.encryptionEnabled!==false){throw new Error('expected encryptionEnabled=false');}"

      - name: Smoke test container (file + encryption)
        run: |
          set -euo pipefail

          # KeyRing JSON with a deterministic all-zero 32-byte key (sufficient for CI smoke testing).
          KEYRING_JSON='{"currentVersion":1,"keys":{"1":"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="}}'

          docker volume create sync-server-ci-data-file > /dev/null
          docker run -d \
            -p 12346:1234 \
            -e SYNC_SERVER_AUTH_TOKEN=ci-token \
            -e SYNC_SERVER_PERSISTENCE_BACKEND=file \
            -e SYNC_SERVER_PERSISTENCE_ENCRYPTION=keyring \
            -e SYNC_SERVER_ENCRYPTION_KEYRING_JSON="$KEYRING_JSON" \
            -e SYNC_SERVER_DATA_DIR=/data \
            -v sync-server-ci-data-file:/data \
            --name sync-server \
            formula-sync-server:ci

          cleanup() {
            docker logs sync-server --tail 200 || true
            docker rm -f sync-server || true
            docker volume rm -f sync-server-ci-data-file || true
          }
          trap cleanup EXIT

          for i in {1..30}; do
            if curl -fsS http://127.0.0.1:12346/healthz > /dev/null; then
              break
            fi
            sleep 1
          done

          curl -fsS http://127.0.0.1:12346/healthz | node -e "const fs=require('fs');const j=JSON.parse(fs.readFileSync(0,'utf8'));console.log(JSON.stringify(j));if(j.backend!=='file'){throw new Error('expected backend=file');}if(j.encryptionEnabled!==true){throw new Error('expected encryptionEnabled=true');}"
