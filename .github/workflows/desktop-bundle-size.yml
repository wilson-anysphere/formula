name: Desktop bundle size

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "apps/desktop/**"
      - "crates/**"
      - "packages/**"
      - "extensions/**"
      - ".cargo/**"
      - "scripts/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - "package.json"
      - "pnpm-lock.yaml"
      - "pnpm-workspace.yaml"
      - ".github/workflows/desktop-bundle-size.yml"
      - ".github/workflows/release.yml"
  pull_request:
    paths:
      - "apps/desktop/**"
      - "crates/**"
      - "packages/**"
      - "extensions/**"
      - ".cargo/**"
      - "scripts/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - "package.json"
      - "pnpm-lock.yaml"
      - "pnpm-workspace.yaml"
      - ".github/workflows/desktop-bundle-size.yml"
      - ".github/workflows/release.yml"

concurrency:
  group: desktop-bundle-size-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  conflict-marker-guard:
    name: "Guard: no merge conflict markers"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Fail if merge conflict markers are present
        run: bash scripts/ci/check-merge-conflict-markers.sh
      - name: "Guard: Rust toolchain pins match rust-toolchain.toml"
        run: bash scripts/ci/check-rust-toolchain-pins.sh

  linux-desktop-bundle-size:
    name: Linux desktop bundle size
    needs: conflict-marker-guard
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          # Pin pnpm patch version for determinism (keep in sync with package.json).
          version: 9.0.0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          # Keep Node pinned to the same major used by CI/release workflows.
          node-version: 22
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@1.92.0

      - name: Install Rust target (wasm32)
        # Required for wasm-pack builds (desktop renderer / engine WASM).
        run: rustup target add wasm32-unknown-unknown

      # Our dev scripts default to a repo-local CARGO_HOME to avoid cross-agent
      # contention on shared ~/.cargo. In GitHub Actions we prefer the default
      # CARGO_HOME so cargo installs/builds share the same cache.
      - name: Use shared Cargo home for CI caching
        run: echo "CARGO_HOME=$HOME/.cargo" >> "$GITHUB_ENV"

      - name: Cache Rust builds
        uses: Swatinem/rust-cache@v2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Linux dependencies (Tauri/WebView + packaging)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            file \
            binutils \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libssl-dev \
            patchelf \
            squashfs-tools

          # Some AppImage tooling requires FUSE2 at runtime. Ubuntu 24.04 renamed the
          # package to `libfuse2t64`; try both, but don't fail the build if neither exists.
          sudo apt-get install -y libfuse2 || sudo apt-get install -y libfuse2t64 || true

      - name: Install JS dependencies
        run: pnpm install --frozen-lockfile

      - name: Install wasm-pack (required for @formula/engine WASM build)
        run: bash scripts/cargo_agent.sh install wasm-pack --locked

      - name: Install cargo-tauri
        run: bash scripts/cargo_agent.sh install cargo-tauri --locked

      - name: Build desktop bundles (Tauri)
        env:
          # The AppImage tooling used by Tauri is itself distributed as an AppImage.
          # In CI we may not have FUSE2 available, so force AppImages to run in
          # "extract-and-run" mode (safe; does not affect the produced artifacts).
          APPIMAGE_EXTRACT_AND_RUN: "1"
        run: cd apps/desktop && bash ../../scripts/cargo_agent.sh tauri build --bundles appimage,deb

      - name: Smoke test produced AppImage (extract + ldd + arch)
        run: bash scripts/ci/check-appimage.sh

      - name: Report desktop bundle sizes
        # If earlier steps fail (dependency install / build), still try to emit an
        # empty report + JSON artifact to aid debugging. When the build succeeds,
        # this step enforces the size gate (if enabled) normally.
        if: always()
        continue-on-error: ${{ failure() }}
        env:
          # Optional: set these as GitHub Actions "Variables" to enable gating.
          # - FORMULA_ENFORCE_BUNDLE_SIZE=1 to fail when any artifact exceeds the limit
          # - FORMULA_BUNDLE_SIZE_LIMIT_MB=50 to adjust the default 50 MB budget
          FORMULA_ENFORCE_BUNDLE_SIZE: ${{ vars.FORMULA_ENFORCE_BUNDLE_SIZE }}
          FORMULA_BUNDLE_SIZE_LIMIT_MB: ${{ vars.FORMULA_BUNDLE_SIZE_LIMIT_MB }}
        run: python scripts/desktop_bundle_size_report.py --json desktop-bundle-size-report.json

      - name: Upload desktop bundle size report (JSON)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: desktop-bundle-size-report
          path: desktop-bundle-size-report.json
          if-no-files-found: warn
