name: Compatibility Scorecard

on:
  workflow_run:
    workflows:
      - corpus
      - Excel Compatibility (Oracle)
    types: [completed]

permissions:
  contents: read
  actions: read

jobs:
  compat-scorecard:
    name: Unified compatibility scorecard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.11"

      - name: Find related workflow runs (by head_sha)
        id: runs
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const sha = context.payload.workflow_run.head_sha;
            const triggeredName = context.payload.workflow_run.name;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            async function findCompletedRunId(workflowFile) {
              const resp = await github.rest.actions.listWorkflowRunsForWorkflow({
                owner,
                repo,
                workflow_id: workflowFile,
                per_page: 50,
              });

              for (const run of resp.data.workflow_runs) {
                if (run.head_sha === sha && run.status === "completed") {
                  return run.id;
                }
              }
              return null;
            }

            let corpusRunId = null;
            let excelRunId = null;
            let shouldGenerate = false;

            if (triggeredName === "corpus") {
              corpusRunId = context.payload.workflow_run.id;
              excelRunId = await findCompletedRunId("excel-compat.yml");
              // If Excel didn't run for this commit, there is no calc metric to report. Avoid
              // emitting a partial scorecard for corpus-only runs.
              shouldGenerate = !!excelRunId;
            } else if (triggeredName === "Excel Compatibility (Oracle)") {
              excelRunId = context.payload.workflow_run.id;
              corpusRunId = await findCompletedRunId("corpus.yml");
              // Always generate after the Excel workflow; corpus metrics are optional and will be
              // marked missing when the corpus workflow did not run for this commit.
              shouldGenerate = true;
            } else {
              // Unexpected; fall back to searching both.
              corpusRunId = await findCompletedRunId("corpus.yml");
              excelRunId = await findCompletedRunId("excel-compat.yml");
              shouldGenerate = !!excelRunId;
            }

            core.setOutput("sha", sha);
            core.setOutput("corpus_run_id", corpusRunId || "");
            core.setOutput("excel_run_id", excelRunId || "");
            core.setOutput("generate", shouldGenerate ? "true" : "false");

            if (!shouldGenerate) {
              core.notice(
                `Not generating scorecard yet for sha ${sha}: corpus=${corpusRunId} excel=${excelRunId}`
              );
            }

      - name: Download corpus summary artifact
        if: ${{ steps.runs.outputs.generate == 'true' && steps.runs.outputs.corpus_run_id != '' }}
        continue-on-error: true
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: corpus-public-summary
          path: artifacts/corpus
          run-id: ${{ steps.runs.outputs.corpus_run_id }}
          github-token: ${{ github.token }}

      - name: Download excel-oracle artifacts
        if: ${{ steps.runs.outputs.generate == 'true' && steps.runs.outputs.excel_run_id != '' }}
        continue-on-error: true
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: excel-oracle-summary
          path: artifacts/excel
          run-id: ${{ steps.runs.outputs.excel_run_id }}
          github-token: ${{ github.token }}

      - name: Generate unified scorecard
        if: ${{ steps.runs.outputs.generate == 'true' }}
        env:
          # Prefer rendering the commit we are summarizing, not the workflow_run runner checkout SHA.
          GITHUB_SHA: ${{ steps.runs.outputs.sha }}
        run: |
          python tools/compat_scorecard.py \
            --corpus-summary artifacts/corpus/tools/corpus/out/public/summary.json \
            --oracle-report artifacts/excel/tests/compatibility/excel-oracle/reports/mismatch-report.json \
            --out-md artifacts/compat_scorecard.md \
            --out-json artifacts/compat_scorecard.json \
            --allow-missing-inputs

          if [ -f artifacts/compat_scorecard.md ]; then
            cat artifacts/compat_scorecard.md >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload unified scorecard
        if: ${{ steps.runs.outputs.generate == 'true' }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: compat-scorecard
          path: |
            artifacts/compat_scorecard.md
            artifacts/compat_scorecard.json
          if-no-files-found: ignore
