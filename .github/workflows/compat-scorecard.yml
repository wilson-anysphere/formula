name: Compatibility Scorecard

on:
  workflow_run:
    workflows:
      - corpus
      - Excel Compatibility (Oracle)
    types: [completed]

permissions:
  contents: read
  actions: read

jobs:
  compat-scorecard:
    name: Unified compatibility scorecard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Find related workflow runs (by head_sha)
        id: runs
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.payload.workflow_run.head_sha;
            const triggeredName = context.payload.workflow_run.name;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            async function findCompletedRunId(workflowFile) {
              const resp = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: workflowFile,
                per_page: 50,
              });

              for (const run of resp.data.workflow_runs) {
                if (run.head_sha === sha && run.status === "completed") {
                  return run.id;
                }
              }
              return null;
            }

            let corpusRunId = null;
            let excelRunId = null;

            if (triggeredName === "corpus") {
              corpusRunId = context.payload.workflow_run.id;
              excelRunId = await findCompletedRunId("excel-compat.yml");
            } else if (triggeredName === "Excel Compatibility (Oracle)") {
              excelRunId = context.payload.workflow_run.id;
              corpusRunId = await findCompletedRunId("corpus.yml");
            } else {
              // Unexpected; fall back to searching both.
              corpusRunId = await findCompletedRunId("corpus.yml");
              excelRunId = await findCompletedRunId("excel-compat.yml");
            }

            core.setOutput("sha", sha);
            core.setOutput("corpus_run_id", corpusRunId || "");
            core.setOutput("excel_run_id", excelRunId || "");
            core.setOutput("ready", corpusRunId && excelRunId ? "true" : "false");

            if (!corpusRunId || !excelRunId) {
              core.notice(
                `Related workflow runs not ready yet for sha ${sha}: corpus=${corpusRunId} excel=${excelRunId}`
              );
            }

      - name: Download corpus summary artifact
        if: ${{ steps.runs.outputs.ready == 'true' }}
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: corpus-public-summary
          path: artifacts/corpus
          run-id: ${{ steps.runs.outputs.corpus_run_id }}
          github-token: ${{ github.token }}

      - name: Download excel-oracle artifacts
        if: ${{ steps.runs.outputs.ready == 'true' }}
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: excel-oracle-artifacts
          path: artifacts/excel
          run-id: ${{ steps.runs.outputs.excel_run_id }}
          github-token: ${{ github.token }}

      - name: Generate unified scorecard
        if: ${{ steps.runs.outputs.ready == 'true' }}
        env:
          # Prefer rendering the commit we are summarizing, not the workflow_run runner checkout SHA.
          GITHUB_SHA: ${{ steps.runs.outputs.sha }}
        run: |
          python tools/compat_scorecard.py \
            --corpus-summary artifacts/corpus/tools/corpus/out/public/summary.json \
            --oracle-report artifacts/excel/tests/compatibility/excel-oracle/reports/mismatch-report.json \
            --out-md artifacts/compat_scorecard.md \
            --out-json artifacts/compat_scorecard.json \
            --allow-missing-inputs

          if [ -f artifacts/compat_scorecard.md ]; then
            cat artifacts/compat_scorecard.md >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload unified scorecard
        if: ${{ steps.runs.outputs.ready == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: compat-scorecard
          path: |
            artifacts/compat_scorecard.md
            artifacts/compat_scorecard.json
          if-no-files-found: ignore
