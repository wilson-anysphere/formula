name: Desktop performance (platform matrix)

on:
  workflow_dispatch:
  schedule:
    # Daily (UTC). Adjust as needed; goal is continuous cross-platform visibility.
    - cron: "0 7 * * *"

env:
  # Keep these in sync with ci.yml/release.yml to reduce cross-workflow drift.
  NODE_VERSION: 22
  WASM_PACK_VERSION: 0.13.1

jobs:
  desktop-startup-perf:
    name: Desktop startup perf (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, windows-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: "Guard: Rust toolchain pins match rust-toolchain.toml"
        shell: bash
        run: bash scripts/ci/check-rust-toolchain-pins.sh

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Setup Rust toolchain (pinned + wasm32)
        uses: dtolnay/rust-toolchain@1.92.0
        with:
          targets: wasm32-unknown-unknown

      # Our dev scripts default to a repo-local CARGO_HOME to avoid cross-agent
      # contention on shared ~/.cargo. In GitHub Actions we prefer the default
      # CARGO_HOME so cargo installs/builds share the same cache.
      - name: Use shared Cargo home for CI caching (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $cargoHome = Join-Path $env:USERPROFILE ".cargo"
          "CARGO_HOME=$cargoHome" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Use shared Cargo home for CI caching (Unix)
        if: matrix.os != 'windows-latest'
        run: echo "CARGO_HOME=$HOME/.cargo" >> "$GITHUB_ENV"

      - name: Install Linux dependencies (Tauri/WebView + headless display)
        if: matrix.os == 'ubuntu-24.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            xvfb \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libssl-dev \
            patchelf

      - name: Install JS dependencies
        run: pnpm install --frozen-lockfile

      - name: Install wasm-pack (required for @formula/engine WASM build)
        run: cargo install wasm-pack --version ${{ env.WASM_PACK_VERSION }} --locked

      - name: Build desktop frontend (Vite + WASM)
        run: pnpm build:desktop

      - name: Desktop dist asset report
        run: node scripts/desktop_dist_asset_report.mjs
        env:
          # Optional: set as GitHub Actions variables to enable gating.
          FORMULA_DESKTOP_DIST_TOTAL_BUDGET_MB: ${{ vars.FORMULA_DESKTOP_DIST_TOTAL_BUDGET_MB }}
          FORMULA_DESKTOP_DIST_SINGLE_FILE_BUDGET_MB: ${{ vars.FORMULA_DESKTOP_DIST_SINGLE_FILE_BUDGET_MB }}

      - name: Build desktop binary (release)
        shell: bash
        run: |
          set -euo pipefail
          if cargo metadata --no-deps --format-version=1 | grep -q '"name":"formula-desktop-tauri"'; then
            cargo build -p formula-desktop-tauri --bin formula-desktop --features desktop --release --locked
          else
            cargo build -p desktop --bin formula-desktop --features desktop --release --locked
          fi

      - name: Run desktop startup benchmark (5 runs)
        id: startup
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p perf-artifacts
          node scripts/run-node-ts.mjs apps/desktop/tests/performance/desktop-startup-runner.ts \
            --runs 5 \
            --timeout-ms 20000 \
            --json perf-artifacts/desktop-startup-metrics.json \
            --allow-ci 2>&1 | tee perf-artifacts/desktop-startup.log

      - name: Run idle memory benchmark (3 runs)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p perf-artifacts
          node scripts/run-node-ts.mjs apps/desktop/tests/performance/desktop-idle-memory-runner.ts \
            --runs 3 \
            --timeout-ms 30000 \
            --idle-wait-ms 5000 \
            --json perf-artifacts/desktop-idle-memory-metrics.json \
            --allow-ci 2>&1 | tee perf-artifacts/desktop-idle-memory.log

      - name: Upload desktop perf artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: desktop-perf-${{ matrix.os }}
          path: |
            perf-artifacts/*.json
            perf-artifacts/*.log
