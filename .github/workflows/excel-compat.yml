name: Excel Compatibility (Oracle)

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "generate-oracle | validate-engine"
        required: true
        default: "validate-engine"
        type: choice
        options:
          - generate-oracle
          - validate-engine
      max_cases:
        description: "Run only first N cases (0 = all). Useful for debugging."
        required: true
        default: "0"
      max_mismatch_rate:
        description: "Fail if mismatches/total exceeds this rate (0-1)."
        required: true
        default: "0.001"
      engine_cmd:
        description: "Optional engine CLI command. If empty, uses FORMULA_ENGINE_CMD env var."
        required: false
        default: ""

jobs:
  excel-oracle:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Generate case corpus (deterministic)
        run: python tools/excel-oracle/generate_cases.py --out tests/compatibility/excel-oracle/cases.json

      - name: Verify case corpus is committed
        run: git diff --exit-code tests/compatibility/excel-oracle/cases.json

      - name: Generate Excel oracle dataset (COM automation)
        shell: powershell
        run: |
          $max = [int]"${{ inputs.max_cases }}"
          $args = @(
            "-CasesPath", "tests/compatibility/excel-oracle/cases.json",
            "-OutPath", "tests/compatibility/excel-oracle/datasets/excel-oracle.json"
          )
          if ($max -gt 0) { $args += @("-MaxCases", $max) }
          powershell -ExecutionPolicy Bypass -File tools/excel-oracle/run-excel-oracle.ps1 @args

      - name: Run formula engine (adapter)
        if: ${{ inputs.mode == 'validate-engine' }}
        shell: powershell
        env:
          FORMULA_ENGINE_CMD: ${{ inputs.engine_cmd }}
        run: |
          $engineCmd = "${{ inputs.engine_cmd }}"
          $args = @(
            "-CasesPath", "tests/compatibility/excel-oracle/cases.json",
            "-OutPath", "tests/compatibility/excel-oracle/datasets/engine-results.json"
          )
          if ($engineCmd -ne "") { $args += @("-EngineCommand", $engineCmd) }
          powershell -ExecutionPolicy Bypass -File tools/excel-oracle/run-engine.ps1 @args

      - name: Compare engine vs Excel oracle
        if: ${{ inputs.mode == 'validate-engine' }}
        shell: powershell
        run: |
          python tools/excel-oracle/compare.py `
            --cases tests/compatibility/excel-oracle/cases.json `
            --expected tests/compatibility/excel-oracle/datasets/excel-oracle.json `
            --actual tests/compatibility/excel-oracle/datasets/engine-results.json `
            --report tests/compatibility/excel-oracle/reports/mismatch-report.json `
            --max-mismatch-rate "${{ inputs.max_mismatch_rate }}"

      - name: Upload oracle dataset + reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: excel-oracle-artifacts
          path: |
            tests/compatibility/excel-oracle/datasets/*.json
            tests/compatibility/excel-oracle/reports/*.json
