name: Excel Compatibility (Oracle)

on:
  pull_request:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      mode:
        description: "generate-oracle | validate-engine"
        required: true
        default: "validate-engine"
        type: choice
        options:
          - generate-oracle
          - validate-engine
      max_cases:
        description: "Run only first N cases (0 = all). Useful for debugging."
        required: true
        default: "0"
      oracle_source:
        description: "auto = use pinned if present, else generate; pinned = force pinned; generate = force Excel generation"
        required: false
        default: "auto"
        type: choice
        options:
          - auto
          - pinned
          - generate
      max_mismatch_rate:
        description: "Fail if mismatches/total exceeds this rate (0-1)."
        required: true
        default: "0.001"
      include_tags:
        description: "Comma-separated tags to include (blank = all)."
        required: false
        default: ""
      exclude_tags:
        description: "Comma-separated tags to exclude (blank = none)."
        required: false
        default: ""
      engine_cmd:
        description: "Optional engine CLI command. If empty, uses FORMULA_ENGINE_CMD env var."
        required: false
        default: ""

env:
  MODE: ${{ github.event.inputs.mode || 'validate-engine' }}
  MAX_CASES: ${{ github.event.inputs.max_cases || '0' }}
  ORACLE_SOURCE: ${{ github.event.inputs.oracle_source || 'auto' }}
  MAX_MISMATCH_RATE: ${{ github.event.inputs.max_mismatch_rate || '' }}
  INCLUDE_TAGS: ${{ github.event.inputs.include_tags || '' }}
  EXCLUDE_TAGS: ${{ github.event.inputs.exclude_tags || '' }}
  ENGINE_CMD: ${{ github.event.inputs.engine_cmd || '' }}

jobs:
  excel-oracle:
    runs-on: windows-latest
    timeout-minutes: 60
    # For push/PR we validate against a pinned dataset (no Excel required).
    # If there is no pinned dataset committed yet, skip the job to avoid failing CI.
    if: ${{ github.event_name == 'workflow_dispatch' || hashFiles('tests/compatibility/excel-oracle/datasets/excel-oracle.pinned.json') != '' }}

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Generate case corpus (deterministic)
        run: python tools/excel-oracle/generate_cases.py --out tests/compatibility/excel-oracle/cases.json

      - name: Verify case corpus is committed
        run: git diff --exit-code tests/compatibility/excel-oracle/cases.json

      - name: Select expected oracle dataset (pinned vs generated)
        id: expected
        shell: powershell
        run: |
          $mode = "${{ env.MODE }}"
          $oracle = "${{ env.ORACLE_SOURCE }}"
          $pinned = "tests/compatibility/excel-oracle/datasets/excel-oracle.pinned.json"
          $generated = "tests/compatibility/excel-oracle/datasets/excel-oracle.json"
          if ($oracle -eq "pinned") {
            if (-not (Test-Path -LiteralPath $pinned)) {
              throw "oracle_source=pinned but pinned dataset not found at $pinned"
            }
            "path=$pinned" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            "source=pinned" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 0
          }

          if ($oracle -eq "generate") {
            "path=$generated" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            "source=generated" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 0
          }

          # auto
          if ($mode -eq "validate-engine" -and (Test-Path -LiteralPath $pinned)) {
            "path=$pinned" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            "source=pinned" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          } else {
            "path=$generated" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            "source=generated" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }

      - name: Generate Excel oracle dataset (COM automation)
        if: ${{ steps.expected.outputs.source == 'generated' }}
        shell: powershell
        run: |
          $max = [int]"${{ env.MAX_CASES }}"
          $includeTags = $env:INCLUDE_TAGS
          $excludeTags = $env:EXCLUDE_TAGS
          $args = @(
            "-CasesPath", "tests/compatibility/excel-oracle/cases.json",
            "-OutPath", "${{ steps.expected.outputs.path }}"
          )
          if ($max -gt 0) { $args += @("-MaxCases", $max) }
          foreach ($t in ($includeTags -split ",")) {
            $tag = $t.Trim()
            if ($tag -ne "") { $args += @("-IncludeTags", $tag) }
          }
          foreach ($t in ($excludeTags -split ",")) {
            $tag = $t.Trim()
            if ($tag -ne "") { $args += @("-ExcludeTags", $tag) }
          }
          powershell -ExecutionPolicy Bypass -File tools/excel-oracle/run-excel-oracle.ps1 @args

      - name: Run formula engine (adapter)
        if: ${{ env.MODE == 'validate-engine' }}
        shell: powershell
        env:
          FORMULA_ENGINE_CMD: ${{ env.ENGINE_CMD }}
        run: |
          $max = [int]"${{ env.MAX_CASES }}"
          $engineCmd = "${{ env.ENGINE_CMD }}"
          $includeTags = $env:INCLUDE_TAGS
          $excludeTags = $env:EXCLUDE_TAGS
          $args = @(
            "-CasesPath", "tests/compatibility/excel-oracle/cases.json",
            "-OutPath", "tests/compatibility/excel-oracle/datasets/engine-results.json"
          )
          if ($max -gt 0) { $args += @("-MaxCases", $max) }
          foreach ($t in ($includeTags -split ",")) {
            $tag = $t.Trim()
            if ($tag -ne "") { $args += @("-IncludeTags", $tag) }
          }
          foreach ($t in ($excludeTags -split ",")) {
            $tag = $t.Trim()
            if ($tag -ne "") { $args += @("-ExcludeTags", $tag) }
          }
          if ($engineCmd -ne "") { $args += @("-EngineCommand", $engineCmd) }
          powershell -ExecutionPolicy Bypass -File tools/excel-oracle/run-engine.ps1 @args

      - name: Compare engine vs Excel oracle
        if: ${{ env.MODE == 'validate-engine' }}
        shell: powershell
        run: |
          $maxRate = $env:MAX_MISMATCH_RATE
          if ([string]::IsNullOrWhiteSpace($maxRate)) {
            # On push/PR we default to a modest threshold so the job is useful
            # early in development while still catching large regressions.
            $maxRate = "0.01"
          }

          $include = $env:INCLUDE_TAGS
          $exclude = $env:EXCLUDE_TAGS
          if ($env:GITHUB_EVENT_NAME -ne "workflow_dispatch") {
            # Default filter for push/PR: restrict to currently implemented
            # core operators + a few baseline functions.
            if ([string]::IsNullOrWhiteSpace($include)) {
              $include = "add,sub,mul,div,cmp,SUM,IF,IFERROR,ISERROR,error"
            }
          }

          $args = @(
            "tools/excel-oracle/compare.py",
            "--cases", "tests/compatibility/excel-oracle/cases.json",
            "--expected", "${{ steps.expected.outputs.path }}",
            "--actual", "tests/compatibility/excel-oracle/datasets/engine-results.json",
            "--report", "tests/compatibility/excel-oracle/reports/mismatch-report.json",
            "--max-mismatch-rate", $maxRate
          )

          foreach ($t in ($include -split ",")) {
            $tag = $t.Trim()
            if ($tag -ne "") { $args += @("--include-tag", $tag) }
          }
          foreach ($t in ($exclude -split ",")) {
            $tag = $t.Trim()
            if ($tag -ne "") { $args += @("--exclude-tag", $tag) }
          }

          python @args

      - name: Upload oracle dataset + reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: excel-oracle-artifacts
          path: |
            tests/compatibility/excel-oracle/datasets/**/*.json
            tests/compatibility/excel-oracle/reports/*.json
