name: Excel Compatibility (Oracle)

on:
  pull_request:
    paths:
      - "Cargo.toml"
      - "Cargo.lock"
      - "crates/**"
      - "tools/excel-oracle/**"
      - "tests/compatibility/excel-oracle/**"
      - "rust-toolchain.toml"
  push:
    branches: [main]
    paths:
      - "Cargo.toml"
      - "Cargo.lock"
      - "crates/**"
      - "tools/excel-oracle/**"
      - "tests/compatibility/excel-oracle/**"
      - "rust-toolchain.toml"
  workflow_dispatch:
    inputs:
      mode:
        description: "generate-oracle | validate-engine"
        required: true
        default: "validate-engine"
        type: choice
        options:
          - generate-oracle
          - validate-engine
      max_cases:
        description: "Run only first N cases (0 = all). Useful for debugging."
        required: true
        default: "0"
      oracle_source:
        description: "auto = use pinned if present, else generate; pinned = force pinned; generate = force Excel generation"
        required: false
        default: "auto"
        type: choice
        options:
          - auto
          - pinned
          - generate
      max_mismatch_rate:
        description: "Fail if mismatches/total exceeds this rate (0-1)."
        required: true
        default: "0.001"
      include_tags:
        description: "Comma-separated tags to include (blank = all)."
        required: false
        default: ""
      exclude_tags:
        description: "Comma-separated tags to exclude (blank = none)."
        required: false
        default: ""
      engine_cmd:
        description: "Optional engine CLI command. If empty, uses FORMULA_ENGINE_CMD env var."
        required: false
        default: ""

env:
  MODE: ${{ github.event.inputs.mode || 'validate-engine' }}
  MAX_CASES: ${{ github.event.inputs.max_cases || '0' }}
  ORACLE_SOURCE: ${{ github.event.inputs.oracle_source || 'auto' }}
  MAX_MISMATCH_RATE: ${{ github.event.inputs.max_mismatch_rate || '' }}
  INCLUDE_TAGS: ${{ github.event.inputs.include_tags || '' }}
  EXCLUDE_TAGS: ${{ github.event.inputs.exclude_tags || '' }}
  ENGINE_CMD: ${{ github.event.inputs.engine_cmd || '' }}

jobs:
  conflict-marker-guard:
    name: "Guard: no merge conflict markers"
    # Pin runner image versions for reproducibility. GitHub's `ubuntu-latest` alias moves
    # over time, which can introduce unexpected breakages in CI guard checks.
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4
      - name: Fail if merge conflict markers are present
        run: bash scripts/ci/check-merge-conflict-markers.sh
      - name: "Guard: Rust toolchain pins match rust-toolchain.toml"
        run: bash scripts/ci/check-rust-toolchain-pins.sh

  excel-oracle:
    needs: conflict-marker-guard
    # Validating the engine (against a pinned dataset) does not require Excel and can run on
    # GitHub-hosted `windows-2022`.
    #
    # Generating a real Excel oracle dataset *does* require desktop Excel, which is typically only
    # available on a self-hosted runner. Route workflow_dispatch runs that need Excel generation to
    # a runner labeled `self-hosted` + `windows` + `excel` (see tools/excel-oracle/self-hosted-runner.md).
    runs-on: ${{ fromJSON((github.event_name == 'workflow_dispatch' && (github.event.inputs.mode == 'generate-oracle' || github.event.inputs.oracle_source == 'generate' || hashFiles('tests/compatibility/excel-oracle/datasets/excel-oracle.pinned.json') == '')) && '["self-hosted","windows","excel"]' || '["windows-2022"]') }}
    timeout-minutes: 60
    # For push/PR we validate against a pinned dataset (no Excel required).
    # If there is no pinned dataset committed yet, skip the job to avoid failing CI.
    if: ${{ github.event_name == 'workflow_dispatch' || hashFiles('tests/compatibility/excel-oracle/datasets/excel-oracle.pinned.json') != '' }}

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: 1.92.0

      # Our dev scripts default to a repo-local CARGO_HOME to avoid cross-agent
      # contention on shared ~/.cargo. In GitHub Actions we prefer the default
      # CARGO_HOME so cargo builds share the same cache.
      - name: Use shared Cargo home for CI caching
        shell: powershell
        run: |
          $cargoHome = Join-Path $env:USERPROFILE ".cargo"
          "CARGO_HOME=$cargoHome" | Out-File -FilePath $env:GITHUB_ENV -Append

      - uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v5
        with:
          python-version: "3.11"

      - name: Compute effective filters (tags + thresholds)
        shell: powershell
        run: |
          $include = $env:INCLUDE_TAGS
          $exclude = $env:EXCLUDE_TAGS
          $maxRate = $env:MAX_MISMATCH_RATE

          if ([string]::IsNullOrWhiteSpace($maxRate)) {
            # On push/PR we default to a modest threshold so the job is useful
            # early in development while still catching large regressions.
            $maxRate = "0.01"
          }

          if ($env:GITHUB_EVENT_NAME -ne "workflow_dispatch") {
            # Default filter for push/PR: restrict to currently implemented
            # core operators + a few baseline functions.
            if ([string]::IsNullOrWhiteSpace($include)) {
              # Include a small amount of dynamic array spill coverage as well.
              $include = "add,sub,mul,div,cmp,SUM,IF,IFERROR,ISERROR,error,range,TRANSPOSE,SEQUENCE,COUNT,COUNTIF,TEXT,VALUE,DATEVALUE,coercion,WORKDAY,NETWORKDAYS,XLOOKUP,XMATCH,FILTER,SORT,UNIQUE,odd_coupon"
            }
          }

          "EFFECTIVE_INCLUDE_TAGS=$include" | Out-File -FilePath $env:GITHUB_ENV -Append
          "EFFECTIVE_EXCLUDE_TAGS=$exclude" | Out-File -FilePath $env:GITHUB_ENV -Append
          "EFFECTIVE_MAX_MISMATCH_RATE=$maxRate" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Generate case corpus (deterministic)
        run: python tools/excel-oracle/generate_cases.py --out tests/compatibility/excel-oracle/cases.json

      - name: Verify case corpus is committed
        run: git diff --exit-code tests/compatibility/excel-oracle/cases.json

      - name: Select expected oracle dataset (pinned vs generated)
        id: expected
        shell: powershell
        run: |
          $mode = "${{ env.MODE }}"
          $oracle = "${{ env.ORACLE_SOURCE }}"
          $pinned = "tests/compatibility/excel-oracle/datasets/excel-oracle.pinned.json"
          $generated = "tests/compatibility/excel-oracle/datasets/excel-oracle.json"
          if ($oracle -eq "pinned") {
            if (-not (Test-Path -LiteralPath $pinned)) {
              throw "oracle_source=pinned but pinned dataset not found at $pinned"
            }
            "path=$pinned" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            "source=pinned" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 0
          }

          if ($oracle -eq "generate") {
            "path=$generated" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            "source=generated" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 0
          }

          # auto
          if ($mode -eq "validate-engine" -and (Test-Path -LiteralPath $pinned)) {
            "path=$pinned" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            "source=pinned" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          } else {
            "path=$generated" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            "source=generated" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }

      - name: Generate Excel oracle dataset (COM automation)
        if: ${{ steps.expected.outputs.source == 'generated' }}
        shell: powershell
        run: |
          $max = [int]"${{ env.MAX_CASES }}"
          $includeTags = $env:EFFECTIVE_INCLUDE_TAGS
          $excludeTags = $env:EFFECTIVE_EXCLUDE_TAGS
          $args = @(
            "-CasesPath", "tests/compatibility/excel-oracle/cases.json",
            "-OutPath", "${{ steps.expected.outputs.path }}"
          )
          if ($max -gt 0) { $args += @("-MaxCases", $max) }
          foreach ($t in ($includeTags -split ",")) {
            $tag = $t.Trim()
            if ($tag -ne "") { $args += @("-IncludeTags", $tag) }
          }
          foreach ($t in ($excludeTags -split ",")) {
            $tag = $t.Trim()
            if ($tag -ne "") { $args += @("-ExcludeTags", $tag) }
          }
          powershell -ExecutionPolicy Bypass -File tools/excel-oracle/run-excel-oracle.ps1 @args

      - name: Run formula engine (adapter)
        if: ${{ env.MODE == 'validate-engine' }}
        shell: powershell
        env:
          FORMULA_ENGINE_CMD: ${{ env.ENGINE_CMD }}
        run: |
          $max = [int]"${{ env.MAX_CASES }}"
          $engineCmd = "${{ env.ENGINE_CMD }}"
          $includeTags = $env:EFFECTIVE_INCLUDE_TAGS
          $excludeTags = $env:EFFECTIVE_EXCLUDE_TAGS
          $args = @(
            "-CasesPath", "tests/compatibility/excel-oracle/cases.json",
            "-OutPath", "tests/compatibility/excel-oracle/datasets/engine-results.json"
          )
          if ($max -gt 0) { $args += @("-MaxCases", $max) }
          foreach ($t in ($includeTags -split ",")) {
            $tag = $t.Trim()
            if ($tag -ne "") { $args += @("-IncludeTags", $tag) }
          }
          foreach ($t in ($excludeTags -split ",")) {
            $tag = $t.Trim()
            if ($tag -ne "") { $args += @("-ExcludeTags", $tag) }
          }
          if ($engineCmd -ne "") { $args += @("-EngineCommand", $engineCmd) }
          powershell -ExecutionPolicy Bypass -File tools/excel-oracle/run-engine.ps1 @args

      - name: Compare engine vs Excel oracle
        if: ${{ env.MODE == 'validate-engine' }}
        shell: powershell
        run: |
          $max = [int]"${{ env.MAX_CASES }}"
          $maxRate = $env:EFFECTIVE_MAX_MISMATCH_RATE
          $include = $env:EFFECTIVE_INCLUDE_TAGS
          $exclude = $env:EFFECTIVE_EXCLUDE_TAGS

           $args = @(
             "tools/excel-oracle/compare.py",
             "--cases", "tests/compatibility/excel-oracle/cases.json",
             "--expected", "${{ steps.expected.outputs.path }}",
             "--actual", "tests/compatibility/excel-oracle/datasets/engine-results.json",
             "--report", "tests/compatibility/excel-oracle/reports/mismatch-report.json",
             # Defense in depth: if any paths in the report are absolute (e.g. self-hosted runners),
             # hash them so artifacts don't leak usernames/mount points. Repo-relative paths remain
             # readable.
             "--privacy-mode", "private",
             "--max-mismatch-rate", $maxRate,
             # Some functions (like odd-coupon bonds) use iterative solvers and can differ from Excel
             # by small floating point amounts even when the math is correct.
             "--tag-abs-tol", "odd_coupon=1e-6",
            "--tag-rel-tol", "odd_coupon=1e-6"
          )
          if ($max -gt 0) { $args += @("--max-cases", $max) }

          foreach ($t in ($include -split ",")) {
            $tag = $t.Trim()
            if ($tag -ne "") { $args += @("--include-tag", $tag) }
          }
          foreach ($t in ($exclude -split ",")) {
            $tag = $t.Trim()
            if ($tag -ne "") { $args += @("--exclude-tag", $tag) }
          }

          python @args

      - name: Write job summary
        if: ${{ always() && env.MODE == 'validate-engine' }}
        shell: powershell
        run: |
          $reportPath = "tests/compatibility/excel-oracle/reports/mismatch-report.json"
          if (-not (Test-Path -LiteralPath $reportPath)) {
            "No mismatch report found at $reportPath" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            exit 0
          }

          $report = Get-Content -LiteralPath $reportPath -Raw -Encoding UTF8 | ConvertFrom-Json
          $s = $report.summary

          "# Excel compatibility report" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "* Total cases: $($s.totalCases)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "* Mismatches: $($s.mismatches)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "* Mismatch rate: $($s.mismatchRate)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "* Max mismatch rate: $($s.maxMismatchRate)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append

          if ($null -ne $s.reasonCounts) {
            "## Mismatch reasons" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            foreach ($p in $s.reasonCounts.PSObject.Properties) {
              "* $($p.Name): $($p.Value)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            }
            "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          }

          if ($null -ne $s.tagSummary -and $s.tagSummary.Count -gt 0) {
            "## Tag summary" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            "| Tag | Passes | Mismatches | Total | Mismatch rate |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            "| --- | ---: | ---: | ---: | ---: |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append

            # Prefer tags that have mismatches; if all green, show the largest tags for context.
            $rows = @($s.tagSummary | Where-Object { $_.mismatches -gt 0 })
            if ($rows.Count -eq 0) {
              $rows = @($s.tagSummary | Select-Object -First 20)
            } else {
              $rows = @($rows | Select-Object -First 30)
            }

            foreach ($row in $rows) {
              $rate = [double]$row.mismatchRate
              "| $($row.tag) | $($row.passes) | $($row.mismatches) | $($row.total) | $($rate.ToString('P2')) |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            }
            "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          }

          if ($null -ne $s.topMissingFunctions -and $s.topMissingFunctions.Count -gt 0) {
            "## Top missing functions" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            foreach ($row in ($s.topMissingFunctions | Select-Object -First 20)) {
              "* `$($row.name)`: $($row.count)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            }
            "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          }

          if ($null -ne $s.topActualErrorKinds -and $s.topActualErrorKinds.Count -gt 0) {
            "## Top actual error kinds (in mismatches)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            foreach ($row in ($s.topActualErrorKinds | Select-Object -First 20)) {
              "* `$($row.code)`: $($row.count)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            }
            "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          }

           if ($null -ne $report.mismatches -and $report.mismatches.Count -gt 0) {
             "## Sample mismatches" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
             "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
             $max = [Math]::Min(10, $report.mismatches.Count)
              for ($i = 0; $i -lt $max; $i++) {
                $m = $report.mismatches[$i]
                "* `$($m.caseId)` `$($m.reason)` `$($m.formula)`" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
              }
            }

      - name: Upload oracle dataset + reports
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: excel-oracle-artifacts
          path: |
            tests/compatibility/excel-oracle/datasets/**/*.json
            tests/compatibility/excel-oracle/reports/*.json

      - name: Upload excel-oracle summary (stable paths)
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: excel-oracle-summary
          path: |
            tests/compatibility/excel-oracle/reports/mismatch-report.json
            tests/compatibility/excel-oracle/reports/summary.md
          if-no-files-found: ignore
