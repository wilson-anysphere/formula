name: Desktop Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

# Prevent multiple runs for the same tag from racing while uploading GitHub Release
# assets (including Tauri updater manifests like `latest.json`). Without this,
# manual re-runs or tag updates can overlap and clobber/partially overwrite the
# release asset set.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  # Queue (don't cancel) subsequent runs so each tag's release assets are written
  # atomically by a single workflow run.
  cancel-in-progress: false

jobs:
  conflict-marker-guard:
    name: "Guard: no merge conflict markers"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Fail if merge conflict markers are present
        run: bash scripts/ci/check-merge-conflict-markers.sh

  validate-version:
    name: Validate desktop version matches tag
    needs: conflict-marker-guard
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Check desktop version matches release tag
        run: node scripts/check-desktop-version.mjs "${{ github.ref_name }}"

  build:
    name: Build (${{ matrix.platform }})
    needs: validate-version
    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest, ubuntu-24.04, windows-latest]

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Validate Tauri updater config
        run: node scripts/check-updater-config.mjs

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install macOS Rust targets (universal build)
        if: matrix.platform == 'macos-latest'
        run: rustup target add x86_64-apple-darwin aarch64-apple-darwin

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Our dev scripts default to a repo-local CARGO_HOME to avoid cross-agent
      # contention on shared ~/.cargo. In GitHub Actions we prefer the default
      # CARGO_HOME so cargo installs/builds share the same cache.
      - name: Use shared Cargo home for CI caching (Windows)
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          $cargoHome = Join-Path $env:USERPROFILE ".cargo"
          "CARGO_HOME=$cargoHome" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Use shared Cargo home for CI caching (Unix)
        if: matrix.platform != 'windows-latest'
        run: echo "CARGO_HOME=$HOME/.cargo" >> "$GITHUB_ENV"

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-24.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            xvfb \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libssl-dev \
            patchelf \
            rpm

          # `appimagetool` is distributed as an AppImage and requires the FUSE 2 runtime.
          # Ubuntu 24.04 uses `libfuse2t64` as part of the time_t 64-bit transition.
          sudo apt-get install -y libfuse2 || sudo apt-get install -y libfuse2t64

      - name: Install JS dependencies
        run: pnpm install --frozen-lockfile

      - name: Install wasm-pack (required for @formula/engine WASM build)
        run: cargo install wasm-pack --locked

      - name: Smoke check packaged cross-origin isolation (COOP/COEP)
        if: matrix.platform == 'ubuntu-24.04'
        run: pnpm -C apps/desktop check:coi

      - name: Build and upload release assets (macOS universal)
        if: matrix.platform == 'macos-latest'
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          # Tauri updater signing (required for auto-update; see docs/release.md)
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

          # Optional platform code signing (see docs/release.md)
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

          WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
          WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
        with:
          projectPath: apps/desktop
          args: --target universal-apple-darwin
          tagName: ${{ github.ref_name }}
          releaseName: Formula ${{ github.ref_name }}
          releaseBody: |
            Automated build for ${{ github.ref_name }}.
            See the assets below for the installers/bundles.
          releaseDraft: true
          prerelease: false

      - name: Build and upload release assets
        if: matrix.platform != 'macos-latest'
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          # Tauri updater signing (required for auto-update; see docs/release.md)
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

          # Optional platform code signing (see docs/release.md)
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

          WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
          WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
        with:
          projectPath: apps/desktop
          tagName: ${{ github.ref_name }}
          releaseName: Formula ${{ github.ref_name }}
          releaseBody: |
            Automated build for ${{ github.ref_name }}.
            See the assets below for the installers/bundles.
          releaseDraft: true
          prerelease: false
          # Explicitly build all required Linux artifact types. We keep `bundle.targets: "all"`
          # in `tauri.conf.json`, but some formats can be skipped if system tooling is missing.
          # This forces the bundler to attempt each required output so the post-build check can
          # catch regressions early.
          args: ${{ matrix.platform == 'ubuntu-24.04' && '--bundles appimage,deb,rpm' || '' }}

      - name: Verify Linux release artifacts (AppImage + deb + rpm + signatures)
        if: matrix.platform == 'ubuntu-24.04'
        shell: bash
        run: |
          set -euo pipefail

          bundle_dir="apps/desktop/src-tauri/target/release/bundle"
          if [[ ! -d "$bundle_dir" ]]; then
            echo "Expected bundle output directory not found: $bundle_dir" >&2
            exit 1
          fi

          shopt -s nullglob
          appimages=("$bundle_dir/appimage"/*.AppImage)
          debs=("$bundle_dir/deb"/*.deb)
          rpms=("$bundle_dir/rpm"/*.rpm)

          echo "Bundle outputs:"
          printf '  AppImage: %s\n' "${#appimages[@]}"
          printf '  deb:      %s\n' "${#debs[@]}"
          printf '  rpm:      %s\n' "${#rpms[@]}"

          if ((${#appimages[@]} == 0)); then
            echo "Missing required Linux artifact: .AppImage" >&2
            exit 1
          fi
          if ((${#debs[@]} == 0)); then
            echo "Missing required Linux artifact: .deb" >&2
            exit 1
          fi
          if ((${#rpms[@]} == 0)); then
            echo "Missing required Linux artifact: .rpm" >&2
            exit 1
          fi

          # Ensure updater signature files exist for each bundle type.
          for artifact in "${appimages[@]}" "${debs[@]}" "${rpms[@]}"; do
            if [[ ! -f "${artifact}.sig" ]]; then
              echo "Missing signature file for ${artifact} (expected ${artifact}.sig)" >&2
              exit 1
            fi
          done

      - name: Verify macOS universal binary (lipo)
        if: matrix.platform == 'macos-latest'
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob

          # Prefer the universal target output when present (Tauri's universal build writes
          # to `target/universal-apple-darwin/...`). Fall back to searching the entire
          # target dir so we fail loudly with useful debugging output if layouts change.
          candidates=(
            apps/desktop/src-tauri/target/universal-apple-darwin/release/bundle/macos/Formula.app/Contents/MacOS/formula-desktop
          )

          bin_path=""
          for candidate in "${candidates[@]}"; do
            if [[ -f "$candidate" ]]; then
              bin_path="$candidate"
              break
            fi
          done

          if [[ -z "$bin_path" ]]; then
            bin_path="$(find apps/desktop/src-tauri/target -type f -path "*/universal-apple-darwin/*/Formula.app/Contents/MacOS/formula-desktop" | head -n 1 || true)"
          fi

          if [[ -z "$bin_path" ]]; then
            bin_path="$(find apps/desktop/src-tauri/target -type f -path "*Formula.app/Contents/MacOS/formula-desktop" | head -n 1 || true)"
          fi

          if [[ -z "$bin_path" ]]; then
            echo "::error::Could not find packaged macOS app binary (expected **/Formula.app/Contents/MacOS/formula-desktop)"
            echo "Searched under: apps/desktop/src-tauri/target"
            echo "Formula.app bundles found:"
            find apps/desktop/src-tauri/target -type d -name "Formula.app" -print || true
            exit 1
          fi

          echo "Found packaged app binary: $bin_path"
          info="$(lipo -info "$bin_path" | tee /dev/stderr)"

          echo "$info" | grep -q "x86_64" || { echo "::error::macOS binary is missing x86_64 slice"; exit 1; }
          echo "$info" | grep -q "arm64" || { echo "::error::macOS binary is missing arm64 slice"; exit 1; }

      - name: Report desktop bundle sizes
        env:
          # Optional: set these as GitHub Actions "Variables" to enable gating.
          # - FORMULA_ENFORCE_BUNDLE_SIZE=1 to fail when any artifact exceeds the limit
          # - FORMULA_BUNDLE_SIZE_LIMIT_MB=50 to adjust the default 50 MB budget
          FORMULA_ENFORCE_BUNDLE_SIZE: ${{ vars.FORMULA_ENFORCE_BUNDLE_SIZE }}
          FORMULA_BUNDLE_SIZE_LIMIT_MB: ${{ vars.FORMULA_BUNDLE_SIZE_LIMIT_MB }}
        run: python scripts/desktop_bundle_size_report.py
