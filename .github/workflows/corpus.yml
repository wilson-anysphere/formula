name: corpus

on:
  pull_request:
    paths:
      - "tools/corpus/**"
      - "docs/compatibility-corpus.md"
      # Run the corpus harness when the XLSX stack changes so we catch compatibility
      # regressions in load/save/diff behavior.
      - "crates/formula-corpus-triage/**"
      - "crates/formula-xlsb/**"
      - "crates/formula-xlsx/**"
      - "crates/xlsx-diff/**"
      - "crates/formula-engine/**"
      - "crates/formula-model/**"
  push:
    branches: ["main"]
    paths:
      - "tools/corpus/**"
      - "docs/compatibility-corpus.md"
      - "crates/formula-corpus-triage/**"
      - "crates/formula-xlsb/**"
      - "crates/formula-xlsx/**"
      - "crates/xlsx-diff/**"
      - "crates/formula-engine/**"
      - "crates/formula-model/**"
  schedule:
    # Nightly full-corpus run (requires secrets)
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      recalc:
        description: "Enable recalculation check (--recalc). Nightly schedule enables this by default."
        required: false
        default: false
        type: boolean
      render_smoke:
        description: "Enable lightweight render smoke test (--render-smoke)."
        required: false
        default: false
        type: boolean

jobs:
  conflict-marker-guard:
    name: "Guard: no merge conflict markers"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Fail if merge conflict markers are present
        run: bash scripts/ci/check-merge-conflict-markers.sh

  public-corpus:
    name: Public corpus triage
    needs: conflict-marker-guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.92.0
      - uses: Swatinem/rust-cache@v2
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      # Our dev scripts default to a repo-local CARGO_HOME to avoid cross-agent
      # contention on shared ~/.cargo. In GitHub Actions we prefer the default
      # CARGO_HOME so the shared cache action works as intended.
      - name: Use shared Cargo home for CI caching
        run: echo "CARGO_HOME=$HOME/.cargo" >> "$GITHUB_ENV"
      - name: Install deps
        run: python -m pip install --upgrade pip cryptography
      - name: Run unit tests
        run: python -m unittest discover -s tools/corpus/tests
      - name: Run triage
        run: |
          python -m tools.corpus.triage \
            --corpus-dir tools/corpus/public \
            --out-dir tools/corpus/out/public \
            --expectations tools/corpus/public/expectations.json \
            --include-xlsb \
            --leak-scan
      - name: Generate dashboard
        run: python -m tools.corpus.dashboard --triage-dir tools/corpus/out/public
      - name: Publish summary
        run: cat tools/corpus/out/public/summary.md >> "$GITHUB_STEP_SUMMARY"
      - uses: actions/upload-artifact@v4
        with:
          name: corpus-public-${{ github.sha }}
          path: tools/corpus/out/public

  private-corpus:
    name: Private corpus triage (scheduled)
    needs: conflict-marker-guard
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    env:
      # Nightly schedule runs at least the Calculate (L2) check. Render smoke (L3) is opt-in.
      CORPUS_RUN_RECALC: ${{ github.event_name == 'schedule' || github.event.inputs.recalc }}
      CORPUS_RUN_RENDER_SMOKE: ${{ github.event.inputs.render_smoke }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.92.0
      - uses: Swatinem/rust-cache@v2
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Restore private corpus trend (time series)
        uses: actions/cache/restore@v4
        with:
          path: tools/corpus/out/private/trend.json
          key: corpus-private-trend-${{ github.run_id }}
          restore-keys: |
            corpus-private-trend-
      # Our dev scripts default to a repo-local CARGO_HOME to avoid cross-agent
      # contention on shared ~/.cargo. In GitHub Actions we prefer the default
      # CARGO_HOME so the shared cache action works as intended.
      - name: Use shared Cargo home for CI caching
        run: echo "CARGO_HOME=$HOME/.cargo" >> "$GITHUB_ENV"
      - name: Install deps
        run: python -m pip install --upgrade pip cryptography
      - name: Materialize private corpus (optional)
        env:
          CORPUS_PRIVATE_TAR_B64: ${{ secrets.CORPUS_PRIVATE_TAR_B64 }}
        run: |
          if [ -z "$CORPUS_PRIVATE_TAR_B64" ]; then
            echo "No CORPUS_PRIVATE_TAR_B64 configured; skipping private corpus."
            exit 0
          fi
          mkdir -p tools/corpus/private
          echo "$CORPUS_PRIVATE_TAR_B64" | base64 -d > /tmp/corpus.tar.gz
          tar -xzf /tmp/corpus.tar.gz -C tools/corpus/private
      - name: Run triage (private)
        env:
          CORPUS_ENCRYPTION_KEY: ${{ secrets.CORPUS_ENCRYPTION_KEY }}
        run: |
          if [ ! -d tools/corpus/private ]; then
            echo "Private corpus directory missing; skipping."
            exit 0
          fi
          EXTRA_FLAGS=()
          if [ "${CORPUS_RUN_RECALC}" = "true" ]; then
            EXTRA_FLAGS+=(--recalc)
          fi
          if [ "${CORPUS_RUN_RENDER_SMOKE}" = "true" ]; then
            EXTRA_FLAGS+=(--render-smoke)
          fi
          python -m tools.corpus.triage \
            --corpus-dir tools/corpus/private \
            --input-scope sanitized \
            --out-dir tools/corpus/out/private \
            --privacy-mode private \
            "${EXTRA_FLAGS[@]}"
      - name: Generate dashboard (private)
        run: |
          # `tools/corpus/out/private/trend.json` may be restored from cache even when
          # triage output is missing; gate on `index.json` to detect actual triage output.
          if [ ! -f tools/corpus/out/private/index.json ]; then
            echo "No private triage output; skipping."
            exit 0
          fi
          python -m tools.corpus.dashboard \
            --triage-dir tools/corpus/out/private \
            --append-trend tools/corpus/out/private/trend.json
      - name: Publish summary (private)
        run: |
          if [ -f tools/corpus/out/private/summary.md ]; then
            cat tools/corpus/out/private/summary.md >> "$GITHUB_STEP_SUMMARY"
          fi
      - name: Publish trend delta (private)
        run: |
          if [ ! -f tools/corpus/out/private/summary.json ]; then
            # Dashboard didn't run, so we didn't append a new trend entry.
            exit 0
          fi
          if [ ! -f tools/corpus/out/private/trend.json ]; then
            exit 0
          fi
          python - <<'PY' >> "$GITHUB_STEP_SUMMARY"
          import json
          from pathlib import Path
          
          p = Path("tools/corpus/out/private/trend.json")
          data = json.loads(p.read_text(encoding="utf-8") or "[]")
          if not isinstance(data, list) or len(data) < 2:
              raise SystemExit(0)
          
          prev, cur = data[-2], data[-1]
          
          def pct(v):
              return "n/a" if v is None else f"{v:.2%}"
          
          def delta_pct(a, b):
              if a is None or b is None:
                  return "n/a"
              return f"{(b - a) * 100:+.2f}pp"
          
          def delta_int(a, b):
              if not isinstance(a, int) or not isinstance(b, int):
                  return "n/a"
              return f"{b - a:+d}"
          
          lines = []
          lines.append("## Trend delta (vs previous private run)")
          lines.append("")
          lines.append(f"- Open rate: **{pct(cur.get('open_rate'))}** ({delta_pct(prev.get('open_rate'), cur.get('open_rate'))})")
          lines.append(f"- Round-trip rate: **{pct(cur.get('round_trip_rate'))}** ({delta_pct(prev.get('round_trip_rate'), cur.get('round_trip_rate'))})")
          lines.append(f"- Calc rate (attempted): **{pct(cur.get('calc_rate'))}** ({delta_pct(prev.get('calc_rate'), cur.get('calc_rate'))}); attempted {cur.get('calc_attempted', 0)}")
          lines.append(f"- Render rate (attempted): **{pct(cur.get('render_rate'))}** ({delta_pct(prev.get('render_rate'), cur.get('render_rate'))}); attempted {cur.get('render_attempted', 0)}")
          
          prev_diff = prev.get("diff_totals") or {}
          cur_diff = cur.get("diff_totals") or {}
          lines.append(
              "- Diff totals (critical/warn/info): "
              f"**{cur_diff.get('critical', 0)}/{cur_diff.get('warning', 0)}/{cur_diff.get('info', 0)}** "
              "("
              f"{delta_int(prev_diff.get('critical'), cur_diff.get('critical'))}/"
              f"{delta_int(prev_diff.get('warning'), cur_diff.get('warning'))}/"
              f"{delta_int(prev_diff.get('info'), cur_diff.get('info'))}"
              ")"
          )
          
          print("\n".join(lines))
          PY
      - name: Compatibility gate (private)
        run: |
          if [ ! -f tools/corpus/out/private/summary.json ]; then
            echo "No private summary.json; skipping compatibility gate."
            exit 0
          fi
          python -m tools.corpus.compat_gate \
            --summary-json tools/corpus/out/private/summary.json \
            --min-round-trip-rate 0.97
      - name: Save private corpus trend cache
        if: always() && hashFiles('tools/corpus/out/private/trend.json') != ''
        uses: actions/cache/save@v4
        with:
          path: tools/corpus/out/private/trend.json
          key: corpus-private-trend-${{ github.run_id }}
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: corpus-private-${{ github.sha }}
          path: tools/corpus/out/private
