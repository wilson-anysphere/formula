name: corpus

on:
  pull_request:
    paths:
      - "tools/corpus/**"
      - "docs/compatibility-corpus.md"
      - "rust-toolchain.toml"
      # Run the corpus harness when the XLSX stack changes so we catch compatibility
      # regressions in load/save/diff behavior.
      - "crates/formula-corpus-triage/**"
      - "crates/formula-xlsb/**"
      - "crates/formula-xlsx/**"
      - "crates/xlsx-diff/**"
      - "crates/formula-engine/**"
      - "crates/formula-model/**"
  push:
    branches: ["main"]
    paths:
      - "tools/corpus/**"
      - "docs/compatibility-corpus.md"
      - "rust-toolchain.toml"
      - "crates/formula-corpus-triage/**"
      - "crates/formula-xlsb/**"
      - "crates/formula-xlsx/**"
      - "crates/xlsx-diff/**"
      - "crates/formula-engine/**"
      - "crates/formula-model/**"
  schedule:
    # Nightly full-corpus run (requires secrets)
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      recalc:
        description: "Enable recalculation check (--recalc). Nightly schedule enables this by default."
        required: false
        default: false
        type: boolean
      render_smoke:
        description: "Enable lightweight render smoke test (--render-smoke)."
        required: false
        default: false
        type: boolean
      gate_load_p90_ms:
        description: "Optional perf gate: fail if load step p90 exceeds this threshold (ms). Empty disables."
        required: false
        default: ""
        type: string
      gate_round_trip_p90_ms:
        description: "Optional perf gate: fail if round_trip step p90 exceeds this threshold (ms). Empty disables."
        required: false
        default: ""
        type: string
      min_calc_rate:
        description: "Optional compatibility gate: fail if calculate pass rate (among attempted) drops below this (0-1). Empty disables."
        required: false
        default: ""
        type: string
      min_calc_cell_fidelity:
        description: "Optional compatibility gate: fail if cell-level calc fidelity (among attempted formula cells) drops below this (0-1). Empty disables."
        required: false
        default: ""
        type: string
      min_render_rate:
        description: "Optional compatibility gate: fail if render pass rate (among attempted) drops below this (0-1). Empty disables."
        required: false
        default: ""
        type: string

jobs:
  conflict-marker-guard:
    name: "Guard: no merge conflict markers"
    # Pin runner image versions for reproducibility. GitHub's `ubuntu-latest` alias moves
    # over time, which can introduce unexpected breakages in corpus automation.
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
      - name: Fail if merge conflict markers are present
        run: bash scripts/ci/check-merge-conflict-markers.sh
      - name: "Guard: Rust toolchain pins match rust-toolchain.toml"
        run: bash scripts/ci/check-rust-toolchain-pins.sh

  public-corpus:
    name: Public corpus triage
    needs: conflict-marker-guard
    runs-on: ubuntu-24.04
    env:
      # Manual workflow_dispatch runs can opt into heavier checks even for the public subset.
      CORPUS_RUN_RECALC: ${{ github.event.inputs.recalc }}
      CORPUS_RUN_RENDER_SMOKE: ${{ github.event.inputs.render_smoke }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
      - uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: 1.92.0
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v5
        with:
          python-version: "3.11"
      # Our dev scripts default to a repo-local CARGO_HOME to avoid cross-agent
      # contention on shared ~/.cargo. In GitHub Actions we prefer the default
      # CARGO_HOME so the shared cache action works as intended.
      - name: Use shared Cargo home for CI caching
        run: echo "CARGO_HOME=$HOME/.cargo" >> "$GITHUB_ENV"
      - name: Install deps
        run: python -m pip install --upgrade pip cryptography
      - name: Run unit tests
        run: python -m unittest discover -s tools/corpus/tests
      - name: Run triage
        run: |
          EXTRA_FLAGS=()
          if [ "${CORPUS_RUN_RECALC}" = "true" ]; then
            EXTRA_FLAGS+=(--recalc)
          fi
          if [ "${CORPUS_RUN_RENDER_SMOKE}" = "true" ]; then
            EXTRA_FLAGS+=(--render-smoke)
          fi
          python -m tools.corpus.triage \
            --corpus-dir tools/corpus/public \
            --out-dir tools/corpus/out/public \
            --expectations tools/corpus/public/expectations.json \
            --include-xlsb \
            --leak-scan \
            "${EXTRA_FLAGS[@]}"
      - name: Generate dashboard
        if: always()
        run: |
          if [ -d tools/corpus/out/public ]; then
            python -m tools.corpus.dashboard --triage-dir tools/corpus/out/public
          else
            echo "No triage output found at tools/corpus/out/public; skipping dashboard generation."
          fi
      - name: Publish summary
        if: always()
        run: |
          if [ -f tools/corpus/out/public/summary.md ]; then
            cat tools/corpus/out/public/summary.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No corpus summary found at tools/corpus/out/public/summary.md"
          fi
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        if: always()
        with:
          name: corpus-public-${{ github.sha }}
          path: tools/corpus/out/public
      - name: Upload corpus public summary (stable paths)
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: corpus-public-summary
          path: |
            tools/corpus/out/public/summary.json
            tools/corpus/out/public/summary.md
          if-no-files-found: ignore

  private-corpus:
    name: Private corpus triage (scheduled)
    needs: conflict-marker-guard
    runs-on: ubuntu-24.04
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    env:
      # Nightly schedule runs at least the Calculate (L2) check by default. This can be disabled by
      # setting vars.CORPUS_RUN_RECALC=false. Render smoke (L3) is opt-in.
      CORPUS_RUN_RECALC: ${{ (github.event_name == 'schedule' && vars.CORPUS_RUN_RECALC != 'false') || github.event.inputs.recalc }}
      # Render smoke can be enabled for workflow_dispatch runs, or (for scheduled runs) via a repo
      # variable `CORPUS_RUN_RENDER_SMOKE=true`.
      CORPUS_RUN_RENDER_SMOKE: ${{ (github.event_name == 'schedule' && vars.CORPUS_RUN_RENDER_SMOKE == 'true') || github.event.inputs.render_smoke }}
      # Optional perf gates (opt-in). Can be configured via workflow_dispatch inputs or repo-level variables.
      CORPUS_GATE_LOAD_P90_MS: ${{ github.event.inputs.gate_load_p90_ms || vars.CORPUS_GATE_LOAD_P90_MS }}
      CORPUS_GATE_ROUND_TRIP_P90_MS: ${{ github.event.inputs.gate_round_trip_p90_ms || vars.CORPUS_GATE_ROUND_TRIP_P90_MS }}
      # Optional compatibility gates for L2/L3 (opt-in). Values are rates in [0,1].
      CORPUS_MIN_CALC_RATE: ${{ github.event.inputs.min_calc_rate || vars.CORPUS_MIN_CALC_RATE }}
      CORPUS_MIN_CALC_CELL_FIDELITY: ${{ github.event.inputs.min_calc_cell_fidelity || vars.CORPUS_MIN_CALC_CELL_FIDELITY }}
      CORPUS_MIN_RENDER_RATE: ${{ github.event.inputs.min_render_rate || vars.CORPUS_MIN_RENDER_RATE }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
      - uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: 1.92.0
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v5
        with:
          python-version: "3.11"
      - name: Prepare private corpus output directory
        run: mkdir -p tools/corpus/out/private
      - name: Restore private corpus trend (time series)
        uses: actions/cache/restore@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v4
        with:
          path: tools/corpus/out/private/trend.json
          key: corpus-private-trend-${{ github.run_id }}
          restore-keys: |
            corpus-private-trend-
      # Our dev scripts default to a repo-local CARGO_HOME to avoid cross-agent
      # contention on shared ~/.cargo. In GitHub Actions we prefer the default
      # CARGO_HOME so the shared cache action works as intended.
      - name: Use shared Cargo home for CI caching
        run: echo "CARGO_HOME=$HOME/.cargo" >> "$GITHUB_ENV"
      - name: Install deps
        run: python -m pip install --upgrade pip cryptography
      - name: Materialize private corpus (optional)
        env:
          CORPUS_PRIVATE_TAR_B64: ${{ secrets.CORPUS_PRIVATE_TAR_B64 }}
        run: |
          if [ -z "$CORPUS_PRIVATE_TAR_B64" ]; then
            echo "No CORPUS_PRIVATE_TAR_B64 configured; skipping private corpus."
            exit 0
          fi
          mkdir -p tools/corpus/private
          echo "$CORPUS_PRIVATE_TAR_B64" | base64 -d > /tmp/corpus.tar.gz
          tar -xzf /tmp/corpus.tar.gz -C tools/corpus/private
      - name: Run triage (private)
        env:
          CORPUS_ENCRYPTION_KEY: ${{ secrets.CORPUS_ENCRYPTION_KEY }}
        run: |
          if [ ! -d tools/corpus/private ]; then
            echo "Private corpus directory missing; skipping."
            exit 0
          fi
          EXTRA_FLAGS=()
          if [ "${CORPUS_RUN_RECALC}" = "true" ]; then
            EXTRA_FLAGS+=(--recalc)
          fi
          if [ "${CORPUS_RUN_RENDER_SMOKE}" = "true" ]; then
            EXTRA_FLAGS+=(--render-smoke)
          fi
          INPUT_SCOPE="auto"
          # Calculate (recalc) requires original inputs + cached formula results, which are often
          # stripped from sanitized corpora. Prefer encrypted originals when available.
          if [ "${CORPUS_RUN_RECALC}" = "true" ] && [ -d tools/corpus/private/originals ]; then
            if [ -z "${CORPUS_ENCRYPTION_KEY}" ]; then
              echo "CORPUS_ENCRYPTION_KEY missing; cannot triage originals. Falling back to input-scope=${INPUT_SCOPE}."
            else
              INPUT_SCOPE="originals"
            fi
          fi
          JOBS="$(python -c 'import os; cpu = os.cpu_count() or 1; print(min(4, cpu))')"
          python -m tools.corpus.triage \
            --corpus-dir tools/corpus/private \
            --input-scope "$INPUT_SCOPE" \
            --out-dir tools/corpus/out/private \
            --privacy-mode private \
            --include-xlsb \
            --jobs "$JOBS" \
            "${EXTRA_FLAGS[@]}"
      - name: Generate dashboard (private)
        run: |
          # `tools/corpus/out/private/trend.json` may be restored from cache even when
          # triage output is missing; gate on `index.json` to detect actual triage output.
          if [ ! -f tools/corpus/out/private/index.json ]; then
            echo "No private triage output; skipping."
            exit 0
          fi
          GATE_FLAGS=()
          if [ -n "${CORPUS_GATE_LOAD_P90_MS}" ]; then
            GATE_FLAGS+=(--gate-load-p90-ms "${CORPUS_GATE_LOAD_P90_MS}")
          fi
          if [ -n "${CORPUS_GATE_ROUND_TRIP_P90_MS}" ]; then
            GATE_FLAGS+=(--gate-round-trip-p90-ms "${CORPUS_GATE_ROUND_TRIP_P90_MS}")
          fi
          python -m tools.corpus.dashboard \
            --triage-dir tools/corpus/out/private \
            --privacy-mode private \
            --append-trend tools/corpus/out/private/trend.json \
            "${GATE_FLAGS[@]}"
      - name: Publish summary (private)
        if: always()
        run: |
          if [ -f tools/corpus/out/private/summary.md ]; then
            cat tools/corpus/out/private/summary.md >> "$GITHUB_STEP_SUMMARY"
          fi
      - name: Publish trend delta (private)
        if: always()
        run: |
          if [ ! -f tools/corpus/out/private/summary.json ]; then
            # Dashboard didn't run, so we didn't append a new trend entry.
            exit 0
          fi
          if [ ! -f tools/corpus/out/private/trend.json ]; then
            exit 0
          fi
          python -m tools.corpus.trend_delta \
            --trend-json tools/corpus/out/private/trend.json \
            --summary-json tools/corpus/out/private/summary.json >> "$GITHUB_STEP_SUMMARY"
      - name: Compatibility gate (private)
        if: always()
        run: |
          if [ ! -f tools/corpus/out/private/summary.json ]; then
            echo "No private summary.json; skipping compatibility gate."
            exit 0
          fi
          GATE_ARGS=(
            --summary-json tools/corpus/out/private/summary.json
            --min-round-trip-rate 0.97
          )
          # Optional L2/L3 gates (opt-in via workflow_dispatch inputs or repo variables).
          if [ -n "${CORPUS_MIN_CALC_RATE}" ] && [ "${CORPUS_RUN_RECALC}" = "true" ]; then
            GATE_ARGS+=(--min-calc-rate "${CORPUS_MIN_CALC_RATE}")
          fi
          if [ -n "${CORPUS_MIN_CALC_CELL_FIDELITY}" ] && [ "${CORPUS_RUN_RECALC}" = "true" ]; then
            GATE_ARGS+=(--min-calc-cell-fidelity "${CORPUS_MIN_CALC_CELL_FIDELITY}")
          fi
          if [ -n "${CORPUS_MIN_RENDER_RATE}" ] && [ "${CORPUS_RUN_RENDER_SMOKE}" = "true" ]; then
            GATE_ARGS+=(--min-render-rate "${CORPUS_MIN_RENDER_RATE}")
          fi
          python -m tools.corpus.compat_gate "${GATE_ARGS[@]}"
      - name: Save private corpus trend cache
        # Only save a new cache entry when we actually produced a new dashboard summary (and thus
        # appended a new trend entry). This avoids filling the cache with identical copies when
        # the private corpus is unavailable (e.g. missing secrets).
        if: always() && hashFiles('tools/corpus/out/private/summary.json') != '' && hashFiles('tools/corpus/out/private/trend.json') != ''
        uses: actions/cache/save@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v4
        with:
          path: tools/corpus/out/private/trend.json
          key: corpus-private-trend-${{ github.run_id }}
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        if: always()
        with:
          name: corpus-private-${{ github.sha }}
          path: tools/corpus/out/private
      - name: Upload corpus private summary (stable paths)
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: corpus-private-summary
          path: |
            tools/corpus/out/private/summary.json
            tools/corpus/out/private/summary.md
          if-no-files-found: ignore
      - name: Upload corpus private trend (stable path)
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: corpus-private-trend
          path: tools/corpus/out/private/trend.json
          if-no-files-found: ignore
