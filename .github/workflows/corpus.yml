name: corpus

on:
  pull_request:
    paths:
      - "tools/corpus/**"
      - "docs/compatibility-corpus.md"
      # Run the corpus harness when the XLSX stack changes so we catch compatibility
      # regressions in load/save/diff behavior.
      - "crates/formula-corpus-triage/**"
      - "crates/formula-xlsb/**"
      - "crates/formula-xlsx/**"
      - "crates/xlsx-diff/**"
      - "crates/formula-engine/**"
      - "crates/formula-model/**"
  push:
    branches: ["main"]
    paths:
      - "tools/corpus/**"
      - "docs/compatibility-corpus.md"
      - "crates/formula-corpus-triage/**"
      - "crates/formula-xlsb/**"
      - "crates/formula-xlsx/**"
      - "crates/xlsx-diff/**"
      - "crates/formula-engine/**"
      - "crates/formula-model/**"
  schedule:
    # Nightly full-corpus run (requires secrets)
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      recalc:
        description: "Enable recalculation check (--recalc). Nightly schedule enables this by default."
        required: false
        default: false
        type: boolean
      render_smoke:
        description: "Enable lightweight render smoke test (--render-smoke)."
        required: false
        default: false
        type: boolean
      gate_load_p90_ms:
        description: "Optional perf gate: fail if load step p90 exceeds this threshold (ms). Empty disables."
        required: false
        default: ""
        type: string
      gate_round_trip_p90_ms:
        description: "Optional perf gate: fail if round_trip step p90 exceeds this threshold (ms). Empty disables."
        required: false
        default: ""
        type: string
      min_calc_rate:
        description: "Optional compatibility gate: fail if calculate pass rate (among attempted) drops below this (0-1). Empty disables."
        required: false
        default: ""
        type: string
      min_render_rate:
        description: "Optional compatibility gate: fail if render pass rate (among attempted) drops below this (0-1). Empty disables."
        required: false
        default: ""
        type: string

jobs:
  conflict-marker-guard:
    name: "Guard: no merge conflict markers"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Fail if merge conflict markers are present
        run: bash scripts/ci/check-merge-conflict-markers.sh
      - name: "Guard: Rust toolchain pins match rust-toolchain.toml"
        run: bash scripts/ci/check-rust-toolchain-pins.sh

  public-corpus:
    name: Public corpus triage
    needs: conflict-marker-guard
    runs-on: ubuntu-latest
    env:
      # Manual workflow_dispatch runs can opt into heavier checks even for the public subset.
      CORPUS_RUN_RECALC: ${{ github.event.inputs.recalc }}
      CORPUS_RUN_RENDER_SMOKE: ${{ github.event.inputs.render_smoke }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.92.0
      - uses: Swatinem/rust-cache@v2
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      # Our dev scripts default to a repo-local CARGO_HOME to avoid cross-agent
      # contention on shared ~/.cargo. In GitHub Actions we prefer the default
      # CARGO_HOME so the shared cache action works as intended.
      - name: Use shared Cargo home for CI caching
        run: echo "CARGO_HOME=$HOME/.cargo" >> "$GITHUB_ENV"
      - name: Install deps
        run: python -m pip install --upgrade pip cryptography
      - name: Run unit tests
        run: python -m unittest discover -s tools/corpus/tests
      - name: Run triage
        run: |
          EXTRA_FLAGS=()
          if [ "${CORPUS_RUN_RECALC}" = "true" ]; then
            EXTRA_FLAGS+=(--recalc)
          fi
          if [ "${CORPUS_RUN_RENDER_SMOKE}" = "true" ]; then
            EXTRA_FLAGS+=(--render-smoke)
          fi
          python -m tools.corpus.triage \
            --corpus-dir tools/corpus/public \
            --out-dir tools/corpus/out/public \
            --expectations tools/corpus/public/expectations.json \
            --include-xlsb \
            --leak-scan \
            "${EXTRA_FLAGS[@]}"
      - name: Generate dashboard
        if: always()
        run: |
          if [ -d tools/corpus/out/public ]; then
            python -m tools.corpus.dashboard --triage-dir tools/corpus/out/public
          else
            echo "No triage output found at tools/corpus/out/public; skipping dashboard generation."
          fi
      - name: Publish summary
        if: always()
        run: |
          if [ -f tools/corpus/out/public/summary.md ]; then
            cat tools/corpus/out/public/summary.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No corpus summary found at tools/corpus/out/public/summary.md"
          fi
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: corpus-public-${{ github.sha }}
          path: tools/corpus/out/public
      - name: Upload corpus public summary (stable paths)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: corpus-public-summary
          path: |
            tools/corpus/out/public/summary.json
            tools/corpus/out/public/summary.md
          if-no-files-found: ignore

  private-corpus:
    name: Private corpus triage (scheduled)
    needs: conflict-marker-guard
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    env:
      # Nightly schedule runs at least the Calculate (L2) check. Render smoke (L3) is opt-in.
      CORPUS_RUN_RECALC: ${{ github.event_name == 'schedule' || github.event.inputs.recalc }}
      CORPUS_RUN_RENDER_SMOKE: ${{ github.event.inputs.render_smoke }}
      # Optional perf gates (opt-in). Can be configured via workflow_dispatch inputs or repo-level variables.
      CORPUS_GATE_LOAD_P90_MS: ${{ github.event.inputs.gate_load_p90_ms || vars.CORPUS_GATE_LOAD_P90_MS }}
      CORPUS_GATE_ROUND_TRIP_P90_MS: ${{ github.event.inputs.gate_round_trip_p90_ms || vars.CORPUS_GATE_ROUND_TRIP_P90_MS }}
      # Optional compatibility gates for L2/L3 (opt-in). Values are rates in [0,1].
      CORPUS_MIN_CALC_RATE: ${{ github.event.inputs.min_calc_rate || vars.CORPUS_MIN_CALC_RATE }}
      CORPUS_MIN_RENDER_RATE: ${{ github.event.inputs.min_render_rate || vars.CORPUS_MIN_RENDER_RATE }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.92.0
      - uses: Swatinem/rust-cache@v2
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Restore private corpus trend (time series)
        uses: actions/cache/restore@v4
        with:
          path: tools/corpus/out/private/trend.json
          key: corpus-private-trend-${{ github.run_id }}
          restore-keys: |
            corpus-private-trend-
      # Our dev scripts default to a repo-local CARGO_HOME to avoid cross-agent
      # contention on shared ~/.cargo. In GitHub Actions we prefer the default
      # CARGO_HOME so the shared cache action works as intended.
      - name: Use shared Cargo home for CI caching
        run: echo "CARGO_HOME=$HOME/.cargo" >> "$GITHUB_ENV"
      - name: Install deps
        run: python -m pip install --upgrade pip cryptography
      - name: Materialize private corpus (optional)
        env:
          CORPUS_PRIVATE_TAR_B64: ${{ secrets.CORPUS_PRIVATE_TAR_B64 }}
        run: |
          if [ -z "$CORPUS_PRIVATE_TAR_B64" ]; then
            echo "No CORPUS_PRIVATE_TAR_B64 configured; skipping private corpus."
            exit 0
          fi
          mkdir -p tools/corpus/private
          echo "$CORPUS_PRIVATE_TAR_B64" | base64 -d > /tmp/corpus.tar.gz
          tar -xzf /tmp/corpus.tar.gz -C tools/corpus/private
      - name: Run triage (private)
        env:
          CORPUS_ENCRYPTION_KEY: ${{ secrets.CORPUS_ENCRYPTION_KEY }}
        run: |
          if [ ! -d tools/corpus/private ]; then
            echo "Private corpus directory missing; skipping."
            exit 0
          fi
          EXTRA_FLAGS=()
          if [ "${CORPUS_RUN_RECALC}" = "true" ]; then
            EXTRA_FLAGS+=(--recalc)
          fi
          if [ "${CORPUS_RUN_RENDER_SMOKE}" = "true" ]; then
            EXTRA_FLAGS+=(--render-smoke)
          fi
          JOBS="$(python -c 'import os; cpu = os.cpu_count() or 1; print(min(4, cpu))')"
          python -m tools.corpus.triage \
            --corpus-dir tools/corpus/private \
            --input-scope sanitized \
            --out-dir tools/corpus/out/private \
            --privacy-mode private \
            --jobs "$JOBS" \
            "${EXTRA_FLAGS[@]}"
      - name: Generate dashboard (private)
        run: |
          # `tools/corpus/out/private/trend.json` may be restored from cache even when
          # triage output is missing; gate on `index.json` to detect actual triage output.
          if [ ! -f tools/corpus/out/private/index.json ]; then
            echo "No private triage output; skipping."
            exit 0
          fi
          GATE_FLAGS=()
          if [ -n "${CORPUS_GATE_LOAD_P90_MS}" ]; then
            GATE_FLAGS+=(--gate-load-p90-ms "${CORPUS_GATE_LOAD_P90_MS}")
          fi
          if [ -n "${CORPUS_GATE_ROUND_TRIP_P90_MS}" ]; then
            GATE_FLAGS+=(--gate-round-trip-p90-ms "${CORPUS_GATE_ROUND_TRIP_P90_MS}")
          fi
          python -m tools.corpus.dashboard \
            --triage-dir tools/corpus/out/private \
            --privacy-mode private \
            --append-trend tools/corpus/out/private/trend.json \
            "${GATE_FLAGS[@]}"
      - name: Publish summary (private)
        if: always()
        run: |
          if [ -f tools/corpus/out/private/summary.md ]; then
            cat tools/corpus/out/private/summary.md >> "$GITHUB_STEP_SUMMARY"
          fi
      - name: Publish trend delta (private)
        if: always()
        run: |
          if [ ! -f tools/corpus/out/private/summary.json ]; then
            # Dashboard didn't run, so we didn't append a new trend entry.
            exit 0
          fi
          if [ ! -f tools/corpus/out/private/trend.json ]; then
            exit 0
          fi
          python - <<'PY' >> "$GITHUB_STEP_SUMMARY"
          import json
          from pathlib import Path
          
          p = Path("tools/corpus/out/private/trend.json")
          try:
              raw = p.read_text(encoding="utf-8").strip()
              data = json.loads(raw or "[]")
          except json.JSONDecodeError:
              raise SystemExit(0)
          if not isinstance(data, list) or len(data) < 2:
              raise SystemExit(0)
          
          prev, cur = data[-2], data[-1]
          
          def pct(v):
              return "n/a" if v is None else f"{v:.2%}"
          
          def delta_pct(a, b):
              if a is None or b is None:
                  return "n/a"
              return f"{(b - a) * 100:+.2f}pp"
          
          def delta_int(a, b):
              if not isinstance(a, int) or not isinstance(b, int):
                  return "n/a"
              return f"{b - a:+d}"

          def ms(v):
              if v is None:
                  return "n/a"
              try:
                  v = float(v)
              except Exception:
                  return "n/a"
              if abs(v - round(v)) < 1e-9:
                  return f"{int(round(v))}ms"
              return f"{v:.1f}ms"

          def delta_ms(a, b):
              if a is None or b is None:
                  return "n/a"
              try:
                  a = float(a)
                  b = float(b)
              except Exception:
                  return "n/a"
              d = b - a
              if abs(d - round(d)) < 1e-9:
                  return f"{int(round(d)):+d}ms"
              return f"{d:+.1f}ms"

          def ratio(v):
              return "n/a" if v is None else f"{float(v):.3f}"

          def delta_ratio(a, b):
              if a is None or b is None:
                  return "n/a"
              return f"{float(b) - float(a):+.3f}"
          lines = []
          lines.append("## Trend delta (vs previous private run)")
          lines.append("")
          lines.append(f"- Open rate: **{pct(cur.get('open_rate'))}** ({delta_pct(prev.get('open_rate'), cur.get('open_rate'))})")
          lines.append(f"- Round-trip rate: **{pct(cur.get('round_trip_rate'))}** ({delta_pct(prev.get('round_trip_rate'), cur.get('round_trip_rate'))})")
          lines.append(f"- Load p90: **{ms(cur.get('load_p90_ms'))}** ({delta_ms(prev.get('load_p90_ms'), cur.get('load_p90_ms'))})")
          lines.append(f"- Round-trip p90: **{ms(cur.get('round_trip_p90_ms'))}** ({delta_ms(prev.get('round_trip_p90_ms'), cur.get('round_trip_p90_ms'))})")
          lines.append(f"- Calc rate (attempted): **{pct(cur.get('calc_rate'))}** ({delta_pct(prev.get('calc_rate'), cur.get('calc_rate'))}); attempted {cur.get('calc_attempted', 0)}")
          lines.append(f"- Render rate (attempted): **{pct(cur.get('render_rate'))}** ({delta_pct(prev.get('render_rate'), cur.get('render_rate'))}); attempted {cur.get('render_attempted', 0)}")

          lines.append(
              f"- Size ratio p90 (output/input): **{ratio(cur.get('size_overhead_p90'))}** "
              f"({delta_ratio(prev.get('size_overhead_p90'), cur.get('size_overhead_p90'))}); "
              f"samples {cur.get('size_overhead_samples', 0)}"
          )

          lines.append(
              f"- Part change ratio p90: **{pct(cur.get('part_change_ratio_p90'))}** "
              f"({delta_pct(prev.get('part_change_ratio_p90'), cur.get('part_change_ratio_p90'))})"
          )
          lines.append(
              f"- Part change ratio p90 (critical): **{pct(cur.get('part_change_ratio_critical_p90'))}** "
              f"({delta_pct(prev.get('part_change_ratio_critical_p90'), cur.get('part_change_ratio_critical_p90'))})"
          )
           
          prev_diff = prev.get("diff_totals") or {}
          cur_diff = cur.get("diff_totals") or {}
          lines.append(
              "- Diff totals (critical/warn/info): "
              f"**{cur_diff.get('critical', 0)}/{cur_diff.get('warning', 0)}/{cur_diff.get('info', 0)}** "
              "("
              f"{delta_int(prev_diff.get('critical'), cur_diff.get('critical'))}/"
              f"{delta_int(prev_diff.get('warning'), cur_diff.get('warning'))}/"
              f"{delta_int(prev_diff.get('info'), cur_diff.get('info'))}"
              ")"
          )
          
          print("\n".join(lines))
          PY
      - name: Compatibility gate (private)
        if: always()
        run: |
          if [ ! -f tools/corpus/out/private/summary.json ]; then
            echo "No private summary.json; skipping compatibility gate."
            exit 0
          fi
          GATE_ARGS=(
            --summary-json tools/corpus/out/private/summary.json
            --min-round-trip-rate 0.97
          )
          # Optional L2/L3 gates (opt-in via workflow_dispatch inputs or repo variables).
          if [ -n "${CORPUS_MIN_CALC_RATE}" ] && [ "${CORPUS_RUN_RECALC}" = "true" ]; then
            GATE_ARGS+=(--min-calc-rate "${CORPUS_MIN_CALC_RATE}")
          fi
          if [ -n "${CORPUS_MIN_RENDER_RATE}" ] && [ "${CORPUS_RUN_RENDER_SMOKE}" = "true" ]; then
            GATE_ARGS+=(--min-render-rate "${CORPUS_MIN_RENDER_RATE}")
          fi
          python -m tools.corpus.compat_gate "${GATE_ARGS[@]}"
      - name: Save private corpus trend cache
        if: always() && hashFiles('tools/corpus/out/private/trend.json') != ''
        uses: actions/cache/save@v4
        with:
          path: tools/corpus/out/private/trend.json
          key: corpus-private-trend-${{ github.run_id }}
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: corpus-private-${{ github.sha }}
          path: tools/corpus/out/private
      - name: Upload corpus private summary (stable paths)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: corpus-private-summary
          path: |
            tools/corpus/out/private/summary.json
            tools/corpus/out/private/summary.md
          if-no-files-found: ignore
      - name: Upload corpus private trend (stable path)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: corpus-private-trend
          path: tools/corpus/out/private/trend.json
          if-no-files-found: ignore
