name: Security

on:
  pull_request:
  push:
    branches: [main]
  schedule:
    # Weekly (Monday 03:17 UTC) to catch newly disclosed CVEs.
    - cron: "17 3 * * 1"
  workflow_dispatch:

permissions:
  contents: read

env:
  # Keep security scans on the same Node.js major as CI/release builds to reduce drift.
  NODE_VERSION: 22

jobs:
  conflict-marker-guard:
    name: "Guard: no merge conflict markers"
    # Pin runner image versions for reproducibility. GitHub's `ubuntu-latest` alias moves
    # over time, which can introduce unexpected breakages in security scanning workflows.
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
      - name: Fail if merge conflict markers are present
        run: bash scripts/ci/check-merge-conflict-markers.sh
      - name: "Guard: Rust toolchain pins match rust-toolchain.toml"
        run: bash scripts/ci/check-rust-toolchain-pins.sh

  security:
    needs: conflict-marker-guard
    runs-on: ubuntu-24.04
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
        with:
          # Secret scanning uses gitleaks in git mode (bounded log opts) to avoid slow full-tree
          # scans once build output directories exist, but we still fetch full history to support
          # future extensions.
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v4
        with:
          # Keep security scans on the same Node.js major as CI/release builds to reduce drift.
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          # Avoid recursive `**/pnpm-lock.yaml` globs (they can be surprisingly slow once the repo
          # has a large `target/` tree). This repo uses a single root lockfile.
          cache-dependency-path: pnpm-lock.yaml

      - name: Enable pnpm via Corepack
        run: |
          corepack enable
          # Pin pnpm patch version for determinism (keep in sync with package.json).
          corepack prepare pnpm@9.0.0 --activate

      - name: Setup Rust (pinned + clippy)
        uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: 1.92.0
          components: clippy

      # Our dev scripts default to a repo-local CARGO_HOME to avoid cross-agent
      # contention on shared ~/.cargo. In GitHub Actions we prefer the default
      # CARGO_HOME so cargo installs and audits share the same cache.
      - name: Use shared Cargo home for CI caching
        shell: bash
        run: echo "CARGO_HOME=$HOME/.cargo" >> "$GITHUB_ENV"

      - name: Install security tooling
        shell: bash
        run: |
          set -euo pipefail

          # cargo-audit (Rust dependency vulnerabilities)
          cargo install cargo-audit --locked

          # gitleaks (secret scanning)
          GITLEAKS_VERSION="8.18.2"
          curl -sSL -o gitleaks.tar.gz \
            "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz"
          curl -sSL -o gitleaks_checksums.txt \
            "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/checksums.txt"
          grep "gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" gitleaks_checksums.txt | sha256sum --check -
          tar -xzf gitleaks.tar.gz gitleaks
          sudo install -m 0755 gitleaks /usr/local/bin/gitleaks

      - name: Run security scans (SAST + audits + secret scanning)
        shell: bash
        run: ./scripts/security/ci.sh

      - name: Upload consolidated security report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: security-report
          path: security-report
