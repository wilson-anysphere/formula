name: Security

on:
  pull_request:
  push:
    branches: [main]
  schedule:
    # Weekly (Monday 03:17 UTC) to catch newly disclosed CVEs.
    - cron: "17 3 * * 1"
  workflow_dispatch:

permissions:
  contents: read

env:
  # Keep security scans on the same Node.js major as CI/release builds to reduce drift.
  NODE_VERSION: 22

jobs:
  conflict-marker-guard:
    name: "Guard: no merge conflict markers"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - name: Fail if merge conflict markers are present
        run: bash scripts/ci/check-merge-conflict-markers.sh
      - name: "Guard: Rust toolchain pins match rust-toolchain.toml"
        run: bash scripts/ci/check-rust-toolchain-pins.sh

  security:
    needs: conflict-marker-guard
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          # Secret scanning is configured to scan the working tree (not git history),
          # but we still fetch full history to support future extensions.
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          # Keep security scans on the same Node.js major as CI/release builds to reduce drift.
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: "**/pnpm-lock.yaml"

      - name: Enable pnpm via Corepack
        run: |
          corepack enable
          # Pin pnpm patch version for determinism (keep in sync with package.json).
          corepack prepare pnpm@9.0.0 --activate

      - name: Setup Rust (pinned + clippy)
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: 1.92.0
          components: clippy

      # Our dev scripts default to a repo-local CARGO_HOME to avoid cross-agent
      # contention on shared ~/.cargo. In GitHub Actions we prefer the default
      # CARGO_HOME so cargo installs and audits share the same cache.
      - name: Use shared Cargo home for CI caching
        shell: bash
        run: echo "CARGO_HOME=$HOME/.cargo" >> "$GITHUB_ENV"

      - name: Install security tooling
        shell: bash
        run: |
          set -euo pipefail

          # cargo-audit (Rust dependency vulnerabilities)
          cargo install cargo-audit --locked

          # gitleaks (secret scanning)
          GITLEAKS_VERSION="8.18.2"
          curl -sSL -o gitleaks.tar.gz \
            "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz"
          curl -sSL -o gitleaks_checksums.txt \
            "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/checksums.txt"
          grep "gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" gitleaks_checksums.txt | sha256sum --check -
          tar -xzf gitleaks.tar.gz gitleaks
          sudo install -m 0755 gitleaks /usr/local/bin/gitleaks

      - name: Run security scans (SAST + audits + secret scanning)
        shell: bash
        run: ./scripts/security/ci.sh

      - name: Upload consolidated security report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: security-report
          path: security-report
